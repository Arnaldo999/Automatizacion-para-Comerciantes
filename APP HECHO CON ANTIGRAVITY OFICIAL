<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üè™ POS - Almac√©n Dashboard</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@700;900&display=swap"
        rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        card: '#1e293b',
                        primary: '#10b981', // Emerald 500
                        secondary: '#3b82f6', // Blue 500
                        accent: '#8b5cf6', // Violet 500
                        warning: '#ef4444', // Red 500
                        gold: '#f59e0b', // Amber 500
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Orbitron', 'monospace'],
                    }
                }
            }
        }
    </script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .screen.active {
            display: block;
            opacity: 1;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .mobile-bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Floating check button for mobile */
        .btn-check-mobile {
            display: none;
            /* Controlled by JS */
        }
    </style>
</head>

<body class="bg-dark text-gray-100 font-sans h-screen overflow-hidden flex">

    <!-- SIDEBAR (Desktop) -->
    <aside class="hidden md:flex flex-col w-64 bg-card border-r border-gray-800 absolute inset-y-0 left-0 z-50">
        <div class="p-6 border-b border-gray-800 text-center">
            <h1 class="text-2xl font-bold text-primary tracking-wider">POS SYSTEM <span
                    class="text-xs bg-gray-800 text-gray-400 px-2 py-0.5 rounded ml-2 border border-gray-700">v2.5</span>
            </h1>
            <p class="text-xs text-gray-400 mt-1">Gesti√≥n Comercial 360</p>
        </div>

        <div class="p-4">
            <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700/50 mb-6">
                <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Usuario</p>
                <div id="sidebarUserName" class="text-primary font-bold text-lg truncate">Cargando...</div>
                <div class="text-xs text-gray-500 mt-1">ID: <span id="sidebarUserId">---</span></div>
            </div>

            <nav class="space-y-2">
                <button onclick="showMenuScreen()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors text-left text-gray-300 hover:text-white">
                    <i class="fa-solid fa-house text-lg w-6 text-center"></i>
                    <span>Inicio</span>
                </button>
                <button onclick="showVentasScreen()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors text-left text-gray-300 hover:text-white">
                    <i class="fa-solid fa-cash-register text-lg w-6 text-center text-primary"></i>
                    <span>Nueva Venta</span>
                </button>
                <button onclick="showGastosScreen()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors text-left text-gray-300 hover:text-white">
                    <i class="fa-solid fa-money-bill-transfer text-lg w-6 text-center text-warning"></i>
                    <span>Registrar Gasto</span>
                </button>
                <button onclick="showHistorialScreen()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors text-left text-gray-300 hover:text-white">
                    <i class="fa-solid fa-chart-line text-lg w-6 text-center text-secondary"></i>
                    <span>Historial</span>
                </button>
                <button onclick="showInventarioScreen()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors text-left text-gray-300 hover:text-white">
                    <i class="fa-solid fa-boxes-stacked text-lg w-6 text-center text-gold"></i>
                    <span>Inventario</span>
                </button>
            </nav>
        </div>

        <div class="mt-auto p-4 border-t border-gray-800">
            <div class="mb-4 text-[10px] text-gray-500 text-center leading-tight">
                &copy; 2024 Arnaldo Ayala<br>
                Todos los Derechos Reservados<br>
                <a href="#" class="hover:text-gray-300">Terminos y Condiciones</a>
            </div>
            <div class="flex items-center gap-3 opacity-90 hover:opacity-100 transition-opacity">
                <div
                    class="w-10 h-10 rounded-full bg-transparent overflow-hidden flex-shrink-0 flex items-center justify-center">
                    <img src="logo.png" class="w-full h-full object-contain" onerror="this.style.display='none'">
                </div>
                <div class="text-xs">
                    <div class="font-bold text-white">Arnaldo Ayala</div>
                    <div class="text-primary text-[10px]">Estratega IA y Marketing</div>
                    <div class="text-[10px] text-gray-500 mt-0.5">+54 376 538 4843</div>
                    <a href="https://arnaldoayalaestratega.com" target="_blank"
                        class="text-[9px] text-secondary hover:text-white block mt-0.5">arnaldoayalaestratega.com</a>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative md:ml-64 w-full">

        <!-- MOBILE HEADER -->
        <header
            class="md:hidden flex items-center justify-between p-4 bg-card/90 backdrop-blur border-b border-gray-800 sticky top-0 z-40">
            <div class="flex items-center gap-3">
                <div class="text-primary text-xl font-bold">POS</div>
                <div id="headerUserName" class="text-sm text-gray-300 font-medium truncate max-w-[150px]">...</div>
            </div>
            <div class="text-xs text-gray-500">ID: <span id="headerUserId">...</span></div>
        </header>

        <!-- CONTENT AREA -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative pb-28 md:pb-8">

            <!-- MEN√ö PRINCIPAL SCREEN -->
            <div id="menu-screen" class="screen active max-w-4xl mx-auto">
                <div class="text-center mb-8 md:mb-12">
                    <div
                        class="inline-block p-2 px-4 rounded-full bg-primary/10 text-primary text-xs font-bold tracking-widest mb-4 border border-primary/20">
                        REPORTE AUTOMATIZADO 360
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white mb-2 tracking-tight">
                        Gesti√≥n <span class="text-primary">Comercial</span>
                    </h1>
                    <p class="text-gray-400">Selecciona una operaci√≥n para comenzar</p>
                </div>

                <!-- Hidden user info fields for JS compatibility -->
                <div class="hidden">
                    <span id="userName"></span><span id="userId"></span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                    <!-- Venta Card -->
                    <button onclick="showVentasScreen()"
                        class="group relative overflow-hidden bg-card hover:bg-gray-800 border border-gray-700 hover:border-primary/50 rounded-2xl p-8 text-center transition-all duration-300 hover:transform hover:-translate-y-1 hover:shadow-2xl hover:shadow-primary/10">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-primary/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                        </div>
                        <div class="relative z-10 flex flex-col items-center gap-4">
                            <div
                                class="w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center text-4xl mb-2 group-hover:scale-110 transition-transform">
                                üí∞
                            </div>
                            <h3 class="text-2xl font-bold text-white">Nueva Venta</h3>
                            <p class="text-sm text-gray-400">Registrar venta y cobro</p>
                        </div>
                    </button>

                    <!-- Gasto Card -->
                    <button onclick="showGastosScreen()"
                        class="group relative overflow-hidden bg-card hover:bg-gray-800 border border-gray-700 hover:border-warning/50 rounded-2xl p-8 text-center transition-all duration-300 hover:transform hover:-translate-y-1 hover:shadow-2xl hover:shadow-warning/10">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-warning/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                        </div>
                        <div class="relative z-10 flex flex-col items-center gap-4">
                            <div
                                class="w-20 h-20 rounded-full bg-warning/10 flex items-center justify-center text-4xl mb-2 group-hover:scale-110 transition-transform">
                                üìä
                            </div>
                            <h3 class="text-2xl font-bold text-white">Registrar Gasto</h3>
                            <p class="text-sm text-gray-400">Salida de dinero</p>
                        </div>
                    </button>

                    <!-- Historial Card -->
                    <button onclick="showHistorialScreen()"
                        class="group relative overflow-hidden bg-card hover:bg-gray-800 border border-gray-700 hover:border-secondary/50 rounded-2xl p-8 text-center transition-all duration-300 hover:transform hover:-translate-y-1 hover:shadow-2xl hover:shadow-secondary/10">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-secondary/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                        </div>
                        <div class="relative z-10 flex flex-col items-center gap-4">
                            <div
                                class="w-20 h-20 rounded-full bg-secondary/10 flex items-center justify-center text-4xl mb-2 group-hover:scale-110 transition-transform">
                                üìà
                            </div>
                            <h3 class="text-2xl font-bold text-white">Ver Historial</h3>
                            <p class="text-sm text-gray-400">Balance y movimientos</p>
                        </div>
                    </button>
                </div>
            </div>

            <!-- VENTAS SCREEN -->
            <div id="ventas-screen" class="screen max-w-3xl mx-auto pb-44 md:pb-0">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="cancelarVenta()"
                        class="md:hidden flex items-center text-gray-400 hover:text-white">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Volver
                    </button>
                    <h2 class="text-2xl font-bold text-primary flex items-center gap-2">
                        <i class="fa-solid fa-cart-shopping"></i> Nueva Venta
                    </h2>
                    <div></div>
                </div>

                <!-- Total Display -->
                <div
                    class="bg-gradient-to-r from-gray-800 to-gray-900 border border-primary/30 rounded-2xl p-6 text-center shadow-lg shadow-primary/5 mb-6 relative overflow-hidden">
                    <div class="text-sm text-gray-400 uppercase tracking-widest mb-1">Total a Cobrar</div>
                    <div id="totalDisplay"
                        class="text-5xl md:text-6xl font-black text-primary font-mono tracking-tighter">$ 0.00</div>
                </div>

                <!-- Input Section -->
                <div class="glass-panel rounded-xl p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div class="relative">
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Monto ($)</label>
                            <input type="text" inputmode="decimal" id="montoInput"
                                class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white text-xl font-bold focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all placeholder-gray-600"
                                placeholder="0.00">
                            <!-- Mobile Floating Check Button (Integrated into input area for better UX) -->
                            <button id="btnCheckMonto" onclick="agregarItem()"
                                class="btn-check-mobile hidden md:hidden absolute right-2 top-[34px] w-10 h-10 bg-primary text-dark rounded-full shadow-lg shadow-primary/40 flex items-center justify-center text-xl font-bold active:scale-95 transition-transform z-10">‚úì</button>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Descripci√≥n /
                                Producto</label>
                            <div class="relative">
                                <input type="text" id="descripcionInput" oninput="buscarProductos(this.value)"
                                    class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white text-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all placeholder-gray-600"
                                    placeholder="Buscar producto o escribir..." autocomplete="off">
                                <button type="button" onclick="limpiarBuscador()" id="btnClearSearch"
                                    class="hidden absolute right-3 top-3 text-gray-400 hover:text-white">‚úï</button>
                                <div id="productosResultados"
                                    class="hidden absolute top-full left-0 w-full mt-1 bg-card border border-gray-700 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto">
                                    <!-- Dynamic Results -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onclick="agregarItem()"
                        class="w-full mt-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition-colors">
                        <i class="fa-solid fa-plus"></i> Agregar Item
                    </button>
                </div>

                <!-- Items List -->
                <div class="glass-panel rounded-xl p-6 mb-24 md:mb-6">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                        <h3 class="font-bold text-gray-300">Items Cargados</h3>
                        <span id="itemsCount"
                            class="bg-primary text-dark font-bold text-xs px-2 py-1 rounded-full">0</span>
                    </div>
                    <div id="itemsList" class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                        <div class="empty-items text-center py-8 text-gray-500">
                            <i class="fa-solid fa-basket-shopping text-3xl mb-2 opacity-50"></i>
                            <p>No hay items agregados</p>
                        </div>
                    </div>
                </div>

                <!-- Footer Actions (Fixed on Mobile) -->
                <div
                    class="fixed bottom-0 left-0 w-full md:relative md:bg-transparent bg-dark/95 border-t md:border-t-0 border-gray-800 p-4 md:p-0 z-40">
                    <div class="grid grid-cols-3 gap-4 max-w-3xl mx-auto">
                        <button onclick="cancelarVenta()"
                            class="col-span-1 bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold py-4 rounded-xl transition-colors">
                            ‚úï
                        </button>
                        <button id="btnCobrar" onclick="mostrarModalCobro()" disabled
                            class="col-span-2 bg-gradient-to-r from-primary to-emerald-600 hover:from-emerald-400 hover:to-primary text-dark font-black text-xl py-4 rounded-xl shadow-lg shadow-primary/20 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex flex-col items-center justify-center leading-none">
                            <span>COBRAR</span>
                            <span id="totalCobrar" class="text-sm opacity-80 font-mono mt-1">$ 0.00</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- GASTOS SCREEN -->
            <div id="gastos-screen" class="screen max-w-lg mx-auto">
                <div class="flex items-center justify-between mb-8">
                    <button onclick="showMenuScreen()"
                        class="md:hidden flex items-center text-gray-400 hover:text-white">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Men√∫
                    </button>
                    <h2 class="text-2xl font-bold text-warning flex items-center gap-2">
                        <i class="fa-solid fa-file-invoice-dollar"></i> Registrar Gasto
                    </h2>
                    <div></div>
                </div>

                <div class="glass-panel rounded-2xl p-8 border border-warning/30 shadow-lg shadow-warning/5">
                    <div class="space-y-6">
                        <div class="relative">
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Monto Gasto ($)</label>
                            <input type="text" inputmode="decimal" id="montoGasto"
                                class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-4 text-white text-2xl font-bold text-center focus:outline-none focus:border-warning focus:ring-1 focus:ring-warning transition-all placeholder-gray-700"
                                placeholder="0.00">
                            <button id="btnCheckGasto" onclick="guardarGasto()"
                                class="btn-check-mobile hidden md:hidden absolute right-3 top-[38px] w-10 h-10 bg-warning text-white rounded-full shadow-lg flex items-center justify-center text-xl font-bold active:scale-95 transition-transform z-10">‚úì</button>
                        </div>

                        <div>
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Categor√≠a</label>
                            <!-- Custom Select Implementation -->
                            <div class="custom-select-wrapper relative">
                                <div id="customSelect" class="relative w-full">
                                    <div id="selectTrigger"
                                        class="flex justify-between items-center w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 cursor-pointer hover:border-warning transition-colors">
                                        <span id="selectedText" class="text-gray-400">Seleccionar categor√≠a...</span>
                                        <i class="fa-solid fa-chevron-down text-xs text-gray-500"></i>
                                    </div>
                                    <div id="customOptions"
                                        class="hidden absolute top-full left-0 w-full mt-2 bg-card border border-gray-700 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto">
                                        <div class="custom-option p-3 hover:bg-gray-700 cursor-pointer text-gray-300 hover:text-warning transition-colors border-b border-gray-700/50 last:border-0"
                                            data-value="Proveedores"><i
                                                class="fa-solid fa-truck mr-2 w-5"></i>Proveedores</div>
                                        <div class="custom-option p-3 hover:bg-gray-700 cursor-pointer text-gray-300 hover:text-warning transition-colors border-b border-gray-700/50 last:border-0"
                                            data-value="Servicios"><i class="fa-solid fa-bolt mr-2 w-5"></i>Servicios
                                        </div>
                                        <div class="custom-option p-3 hover:bg-gray-700 cursor-pointer text-gray-300 hover:text-warning transition-colors border-b border-gray-700/50 last:border-0"
                                            data-value="Alquiler"><i class="fa-solid fa-building mr-2 w-5"></i>Alquiler
                                        </div>
                                        <div class="custom-option p-3 hover:bg-gray-700 cursor-pointer text-gray-300 hover:text-warning transition-colors border-b border-gray-700/50 last:border-0"
                                            data-value="Sueldos"><i class="fa-solid fa-users mr-2 w-5"></i>Sueldos</div>
                                        <div class="custom-option p-3 hover:bg-gray-700 cursor-pointer text-gray-300 hover:text-warning transition-colors border-b border-gray-700/50 last:border-0"
                                            data-value="Otros"><i class="fa-solid fa-ellipsis mr-2 w-5"></i>Otros</div>
                                    </div>
                                </div>
                                <input type="hidden" id="categoriaGasto" name="categoriaGasto" value="">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Detalle
                                (Opcional)</label>
                            <textarea id="descripcionGasto"
                                class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-warning focus:ring-1 focus:ring-warning transition-all placeholder-gray-600 resize-none h-24"
                                placeholder="Ej: Pago de luz..."></textarea>
                        </div>

                        <button id="btnGuardarGasto" onclick="guardarGasto()"
                            class="w-full bg-warning hover:bg-red-600 text-white font-bold text-lg py-4 rounded-xl shadow-lg shadow-warning/20 transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-save"></i> GUARDAR GASTO
                        </button>
                    </div>
                </div>
            </div>

            <!-- INVENTARIO SCREEN -->
            <div id="inventario-screen" class="screen max-w-lg mx-auto pb-24 md:pb-0">
                <div class="flex items-center justify-between mb-8">
                    <button onclick="showMenuScreen()"
                        class="md:hidden flex items-center text-gray-400 hover:text-white">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Men√∫
                    </button>
                    <h2 class="text-2xl font-bold text-gold flex items-center gap-2">
                        <i class="fa-solid fa-boxes-stacked"></i> Inventario
                    </h2>
                    <div></div>
                </div>

                <div class="glass-panel rounded-2xl p-6 border border-gold/30 shadow-lg shadow-gold/5 mb-6">
                    <h3 class="text-gold font-bold mb-4 uppercase text-xs tracking-wider">Nuevo Producto</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Nombre del
                                Producto</label>
                            <input type="text" id="invNombre"
                                class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-all">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Precio ($)</label>
                                <input type="number" id="invPrecio"
                                    class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-all">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">C√≥digo
                                    (Opcional)</label>
                                <input type="text" id="invCodigo"
                                    class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-all">
                            </div>
                        </div>
                        <button onclick="guardarProducto()" id="btnGuardarProducto"
                            class="w-full bg-gold hover:bg-amber-600 text-dark font-bold py-3 rounded-lg transition-colors flex items-center justify-center gap-2 mt-2">
                            <i class="fa-solid fa-plus"></i> Guardar Producto
                        </button>
                    </div>
                </div>

                <div class="glass-panel rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                        <h3 class="font-bold text-gray-300">Lista de Productos</h3>
                        <button onclick="cargarInventario()" class="text-xs text-gold hover:text-white"><i
                                class="fa-solid fa-sync"></i> Actualizar</button>
                    </div>
                    <div id="listaInventario" class="space-y-3 max-h-[400px] overflow-y-auto">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fa-solid fa-box-open text-3xl mb-2 opacity-50"></i>
                            <p>Cargando inventario...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HISTORIAL SCREEN -->
            <div id="historial-screen" class="screen max-w-4xl mx-auto pb-24 md:pb-0">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="showMenuScreen()"
                        class="md:hidden flex items-center text-gray-400 hover:text-white">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Men√∫
                    </button>
                    <h2 class="text-2xl font-bold text-secondary flex items-center gap-2">
                        <i class="fa-solid fa-list-check"></i> Historial
                    </h2>
                    <div></div>
                </div>

                <!-- Chart Container -->
                <div class="bg-card/50 border border-gray-700/50 rounded-2xl p-4 mb-6 relative h-64 w-full">
                    <canvas id="balanceChart"></canvas>
                </div>

                <!-- Balance Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div
                        class="col-span-1 md:col-span-3 bg-gradient-to-r from-gray-800 to-gray-900 border border-secondary/30 rounded-2xl p-6 text-center shadow-lg relative">
                        <div class="text-gray-400 text-sm font-bold uppercase tracking-widest mb-2">Balance Neto</div>
                        <div id="balanceTotal"
                            class="text-4xl md:text-5xl font-mono font-bold text-white transition-colors">$ 0.00</div>
                    </div>
                    <div class="bg-card/50 border border-primary/20 rounded-xl p-4 text-center">
                        <div class="text-xs text-gray-400 uppercase">Ingresos</div>
                        <div id="totalIngresos" class="text-2xl font-bold text-primary">$ 0.00</div>
                    </div>
                    <div class="bg-card/50 border border-warning/20 rounded-xl p-4 text-center">
                        <div class="text-xs text-gray-400 uppercase">Gastos</div>
                        <div id="totalGastos" class="text-2xl font-bold text-warning">$ 0.00</div>
                    </div>
                    <div
                        class="hidden md:block bg-card/50 border border-gray-700 rounded-xl p-4 text-center flex items-center justify-center">
                        <span class="text-gray-500 text-sm">Resumen del Periodo</span>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex justify-center p-1 bg-gray-800 rounded-lg mb-6 max-w-md mx-auto">
                    <button
                        class="filter-tab flex-1 py-2 px-4 rounded-md text-sm font-medium text-gray-400 transition-all hover:text-white active bg-gray-700 text-white shadow"
                        data-filter="semana" onclick="cambiarFiltro('semana')">Semana</button>
                    <button
                        class="filter-tab flex-1 py-2 px-4 rounded-md text-sm font-medium text-gray-400 transition-all hover:text-white"
                        data-filter="mes" onclick="cambiarFiltro('mes')">Mes</button>
                    <button
                        class="filter-tab flex-1 py-2 px-4 rounded-md text-sm font-medium text-gray-400 transition-all hover:text-white"
                        data-filter="a√±o" onclick="cambiarFiltro('a√±o')">A√±o</button>
                </div>

                <!-- Transactions List -->
                <div id="transactionsContainer" class="space-y-3">
                    <div class="loading text-center py-10 text-secondary">
                        <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-2"></i>
                        <p>Cargando transacciones...</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- MOBILE BOTTOM NAV -->
    <nav
        class="md:hidden fixed bottom-0 left-0 w-full bg-card/95 backdrop-blur border-t border-gray-800 z-50 mobile-bottom-nav">
        <div class="grid grid-cols-5 h-16">
            <button onclick="showMenuScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white active:text-primary transition-colors">
                <i class="fa-solid fa-house text-lg mb-1"></i>
                <span class="text-[10px]">Inicio</span>
            </button>
            <button onclick="showVentasScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white active:text-primary transition-colors">
                <i class="fa-solid fa-cash-register text-lg mb-1"></i>
                <span class="text-[10px]">Ventas</span>
            </button>
            <button onclick="showGastosScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white active:text-warning transition-colors">
                <i class="fa-solid fa-file-invoice-dollar text-lg mb-1"></i>
                <span class="text-[10px]">Gastos</span>
            </button>
            <button onclick="showHistorialScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white active:text-secondary transition-colors">
                <i class="fa-solid fa-clock-rotate-left text-lg mb-1"></i>
                <span class="text-[10px]">Historial</span>
            </button>
            <button onclick="showInventarioScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white active:text-gold transition-colors">
                <i class="fa-solid fa-boxes-stacked text-lg mb-1"></i>
                <span class="text-[10px]">Inventario</span>
            </button>
        </div>
    </nav>

    <!-- MODAL COBRO -->
    <div id="modalCobro"
        class="modal-overlay fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div
            class="bg-card border border-primary/50 rounded-2xl p-6 w-full max-w-sm shadow-2xl relative animate-[fadeIn_0.3s_ease-out]">
            <button onclick="cerrarModalCobro()"
                class="absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button>

            <div class="text-center mb-6">
                <h3 class="text-gray-400 text-sm font-bold uppercase tracking-wider mb-2">Total a Pagar</h3>
                <div id="modalAmount" class="text-4xl font-mono font-bold text-primary">$ 0.00</div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="procesarCobro('Efectivo')"
                    class="p-4 bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-primary/50 rounded-xl flex flex-col items-center gap-2 transition-all">
                    <span class="text-2xl">üíµ</span>
                    <span class="text-sm font-bold">Efectivo</span>
                </button>
                <button onclick="procesarCobro('Tarjeta')"
                    class="p-4 bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-primary/50 rounded-xl flex flex-col items-center gap-2 transition-all">
                    <span class="text-2xl">üí≥</span>
                    <span class="text-sm font-bold">Tarjeta</span>
                </button>
                <button onclick="procesarCobro('Transferencia')"
                    class="p-4 bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-primary/50 rounded-xl flex flex-col items-center gap-2 transition-all">
                    <span class="text-2xl">üè¶</span>
                    <span class="text-sm font-bold">Transferencia</span>
                </button>
                <button onclick="procesarCobro('Fiado')"
                    class="p-4 bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-primary/50 rounded-xl flex flex-col items-center gap-2 transition-all">
                    <span class="text-2xl">üìù</span>
                    <span class="text-sm font-bold">Fiado</span>
                </button>
            </div>

            <button onclick="cerrarModalCobro()"
                class="w-full py-3 rounded-lg text-gray-400 hover:text-white font-medium hover:bg-gray-800 transition-colors">Cancelar
                Operaci√≥n</button>
        </div>
    </div>

    <!-- MODAL EDITAR -->
    <div id="modalEdit"
        class="modal-edit fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
        <div
            class="bg-card border border-secondary rounded-2xl p-6 w-full max-w-sm shadow-2xl relative animate-[fadeIn_0.3s_ease-out]">
            <h3 class="text-xl font-bold text-secondary mb-6 text-center">Editar Transacci√≥n</h3>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-xs text-gray-400 mb-1 font-bold">Nuevo Monto</label>
                    <input type="number" id="editMonto" step="0.01" min="0"
                        class="w-full bg-dark border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-secondary">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1 font-bold">Descripci√≥n</label>
                    <input type="text" id="editDescripcion"
                        class="w-full bg-dark border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-secondary">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="cerrarModalEdit()"
                    class="py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white">Cancelar</button>
                <button onclick="guardarEdicion()"
                    class="py-2 rounded-lg bg-secondary hover:bg-blue-600 text-white font-bold">Guardar</button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="notification"
        class="fixed top-20 right-4 p-4 rounded-lg shadow-2xl transform translate-x-[150%] transition-transform duration-300 z-[100] flex items-center gap-3 min-w-[300px] border-l-4">
        <div id="notifIcon" class="text-xl"></div>
        <div id="notifMessage" class="font-bold text-sm"></div>
    </div>

    <!-- CONFETTI SCRIPT (Simple version for success) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- ORIGINAL LOGIC -->
    <script>
        const WEBHOOKS = {
            CONSULTA: 'https://n8n-comerciantes-n8n.yqsgz7.easypanel.host/webhook/comerciante',
            GUARDAR: 'https://n8n-comerciantes-n8n.yqsgz7.easypanel.host/webhook/pos-guardar-venta',
            HISTORIAL: 'https://n8n-comerciantes-n8n.yqsgz7.easypanel.host/webhook/historial',
            EDITAR: 'https://n8n-comerciantes-n8n.yqsgz7.easypanel.host/webhook/transaccion-actualizar',
            ELIMINAR: 'https://n8n-comerciantes-n8n.yqsgz7.easypanel.host/webhook/transaccion-eliminar',
            INVENTARIO: 'https://n8n-comerciantes-n8n.yqsgz7.easypanel.host/webhook/inventario',
            CONSULTA_INVENTARIO: 'https://n8n-comerciantes-n8n.yqsgz7.easypanel.host/webhook/consulta-inventario'
        };

        let comercianteData = { id: '', nombre: '', uuid: '' };
        let ventaActual = { items: [], total: 0 };
        let contadorProductos = 1;
        let transaccionesData = [];
        let filtroActual = 'semana';
        let transaccionEditando = null;
        let inventario = []; // Local cache of inventory
        let balanceChart = null;

        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            if (!id) {
                mostrarNotificacion('‚ùå Error: ID ausente en la URL', 'error');
                return;
            }
            await cargarComercianteData(id);
            cargarVentaGuardada();
            // Load inventory in background
            cargarInventario();
        });

        // --- CORE FUNCTIONS ---
        async function cargarComercianteData(id) {
            try {
                const response = await fetch(`${WEBHOOKS.CONSULTA}?id=${id}`);
                const data = await response.json();

                if (data.error) {
                    mostrarNotificacion(`‚ùå ${data.message}`, 'error');
                    return;
                }

                comercianteData = {
                    id: id,
                    nombre: data.nombre || data.Nombre_Local || 'Comerciante',
                    uuid: data.uuid || data.id || ''
                };

                updateUIFields('userName', comercianteData.nombre);
                updateUIFields('userId', comercianteData.id);
                updateUIFields('sidebarUserName', comercianteData.nombre);
                updateUIFields('sidebarUserId', comercianteData.id);
                updateUIFields('headerUserName', comercianteData.nombre);
                updateUIFields('headerUserId', comercianteData.id);

            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('‚ùå Error al cargar datos', 'error');
            }
        }

        function updateUIFields(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        // --- SCREEN NAVIGATION ---
        function showMenuScreen() { hideAllScreens(); document.getElementById('menu-screen').classList.add('active'); }
        function showVentasScreen() { hideAllScreens(); document.getElementById('ventas-screen').classList.add('active'); document.getElementById('montoInput').focus(); }
        function showGastosScreen() { hideAllScreens(); document.getElementById('gastos-screen').classList.add('active'); document.getElementById('montoGasto').focus(); }
        function showInventarioScreen() { hideAllScreens(); document.getElementById('inventario-screen').classList.add('active'); }
        async function showHistorialScreen() { hideAllScreens(); document.getElementById('historial-screen').classList.add('active'); await cargarHistorial(); }
        function hideAllScreens() { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); }

        // --- INVENTORY LOGIC ---
        async function cargarInventario() {
            if (!comercianteData.id) return;

            const listEl = document.getElementById('listaInventario');
            listEl.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa-solid fa-spinner fa-spin text-3xl mb-2"></i><p>Actualizando...</p></div>';

            try {
                const response = await fetch(`${WEBHOOKS.CONSULTA_INVENTARIO}?id_comerciante=${comercianteData.id}`);
                const data = await response.json();

                // Assuming data is array of products
                inventario = Array.isArray(data) ? data : (data.productos || []);
                renderInventarioList();
            } catch (e) {
                console.error('Error loading inventory:', e);
                listEl.innerHTML = '<div class="text-center py-8 text-red-500"><p>Error al cargar inventario</p></div>';
            }
        }

        function renderInventarioList() {
            const listEl = document.getElementById('listaInventario');
            if (inventario.length === 0) {
                listEl.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa-solid fa-box-open text-3xl mb-2 opacity-50"></i><p>No hay productos registrados</p></div>';
                return;
            }
            listEl.innerHTML = inventario.map(p => `
                <div class="flex justify-between items-center p-3 bg-dark/40 rounded-lg border border-gray-700">
                    <div>
                        <div class="font-bold text-white">${p.nombre}</div>
                        <div class="text-xs text-gray-500">${p.codigo || 'S/C'}</div>
                    </div>
                    <div class="font-mono font-bold text-gold">$ ${p.precio}</div>
                </div>
            `).join('');
        }

        async function guardarProducto() {
            const nombre = document.getElementById('invNombre').value.trim();
            const precio = parseFloat(document.getElementById('invPrecio').value);
            const codigo = document.getElementById('invCodigo').value.trim();

            if (!nombre || !precio) { mostrarNotificacion('‚ö†Ô∏è Nombre y Precio requeridos', 'error'); return; }

            const btn = document.getElementById('btnGuardarProducto');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';
            btn.disabled = true;

            try {
                const payload = {
                    id_comerciante: comercianteData.id,
                    nombre: nombre,
                    precio: precio,
                    codigo: codigo
                };

                await fetch(WEBHOOKS.INVENTARIO, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                mostrarNotificacion('‚úÖ Producto guardado', 'success');
                document.getElementById('invNombre').value = '';
                document.getElementById('invPrecio').value = '';
                document.getElementById('invCodigo').value = '';

                cargarInventario(); // Reload
            } catch (e) {
                mostrarNotificacion('‚ùå Error al guardar', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- SEARCH LOGIC (SALES) ---
        function buscarProductos(query) {
            const resultsEl = document.getElementById('productosResultados');
            const btnClear = document.getElementById('btnClearSearch');

            if (!query) {
                resultsEl.classList.add('hidden');
                btnClear.classList.add('hidden');
                return;
            }

            btnClear.classList.remove('hidden');
            const filtered = inventario.filter(p =>
                p.nombre.toLowerCase().includes(query.toLowerCase()) ||
                (p.codigo && p.codigo.includes(query))
            );

            if (filtered.length === 0) {
                resultsEl.innerHTML = '<div class="p-3 text-gray-500 text-sm text-center">No encontrado. <br><span class="text-xs">Presiona Enter para usar texto libre.</span></div>';
            } else {
                resultsEl.innerHTML = filtered.map(p => `
                    <div onclick="seleccionarProducto('${p.nombre}', ${p.precio})" class="p-3 hover:bg-gray-700 cursor-pointer border-b border-gray-700/50 last:border-0">
                        <div class="font-bold text-white text-sm">${p.nombre}</div>
                        <div class="flex justify-between text-xs text-gray-400">
                            <span>${p.codigo || ''}</span>
                            <span class="text-primary font-mono">$ ${p.precio}</span>
                        </div>
                    </div>
                `).join('');
            }
            resultsEl.classList.remove('hidden');
        }

        function seleccionarProducto(nombre, precio) {
            document.getElementById('descripcionInput').value = nombre;
            // document.getElementById('montoInput').value = precio; // Optional: auto-fill price
            // User asked just for search, but usually POS fills price. I won't force it unless requested, but it's UX best practice.
            // I'll auto-fill price for convenience.
            const montoIn = document.getElementById('montoInput');
            if (montoIn.value === '' || parseFloat(montoIn.value) === 0) {
                montoIn.value = precio;
            }
            limpiarBuscador();
            document.getElementById('montoInput').focus();
        }

        function limpiarBuscador() {
            document.getElementById('productosResultados').classList.add('hidden');
            document.getElementById('btnClearSearch').classList.add('hidden');
        }

        // --- SALES LOGIC ---
        function agregarItem() {
            const inputMonto = document.getElementById('montoInput');
            const inputDesc = document.getElementById('descripcionInput');
            const monto = parseFloat(inputMonto.value);

            if (!monto || monto <= 0) { mostrarNotificacion('‚ö†Ô∏è Ingresa monto v√°lido', 'error'); return; }

            const descripcion = inputDesc.value.trim() || `Producto ${contadorProductos}`;
            ventaActual.items.push({ monto: monto, descripcion: descripcion });
            contadorProductos++;
            ventaActual.total += monto;
            actualizarDisplayTotal();
            actualizarListaItems();
            guardarVentaTemporal();

            inputMonto.value = '';
            inputDesc.value = '';
            inputMonto.focus();

            // Animation
            const totalEl = document.getElementById('totalDisplay');
            totalEl.classList.add('scale-110', 'text-white');
            setTimeout(() => totalEl.classList.remove('scale-110', 'text-white'), 200);
        }

        function actualizarDisplayTotal() {
            const totalF = ventaActual.total.toFixed(2);
            document.getElementById('totalDisplay').textContent = `$ ${totalF}`;
            document.getElementById('totalCobrar').textContent = `$ ${totalF}`;
            document.getElementById('btnCobrar').disabled = ventaActual.items.length === 0;
        }

        function actualizarListaItems() {
            const list = document.getElementById('itemsList');
            document.getElementById('itemsCount').textContent = ventaActual.items.length;

            if (ventaActual.items.length === 0) {
                list.innerHTML = `<div class="empty-items text-center py-8 text-gray-500"><i class="fa-solid fa-basket-shopping text-3xl mb-2 opacity-50"></i><p>No hay items agregados</p></div>`;
                return;
            }

            list.innerHTML = ventaActual.items.map((item, idx) => `
                <div class="flex justify-between items-center p-3 bg-dark/40 rounded-lg border border-gray-700 animate-[fadeIn_0.2s_ease-out]">
                    <div>
                        <div class="text-sm font-medium text-gray-300">${item.descripcion}</div>
                        <div class="text-lg font-bold text-primary font-mono">$ ${item.monto.toFixed(2)}</div>
                    </div>
                    <button onclick="eliminarItem(${idx})" class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500 hover:text-white transition-colors">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function eliminarItem(idx) {
            ventaActual.total -= ventaActual.items[idx].monto;
            ventaActual.items.splice(idx, 1);
            actualizarDisplayTotal(); actualizarListaItems(); guardarVentaTemporal();
        }

        function cancelarVenta() {
            if (ventaActual.items.length > 0 && !confirm('¬øCancelar venta actual?')) return;
            ventaActual = { items: [], total: 0 };
            contadorProductos = 1;
            actualizarDisplayTotal(); actualizarListaItems(); limpiarVentaTemporal();
            showMenuScreen();
        }

        function mostrarModalCobro() {
            document.getElementById('modalAmount').textContent = `$ ${ventaActual.total.toFixed(2)}`;
            document.getElementById('modalCobro').classList.remove('hidden');
            document.getElementById('modalCobro').classList.add('flex');
        }
        function cerrarModalCobro() {
            document.getElementById('modalCobro').classList.add('hidden');
            document.getElementById('modalCobro').classList.remove('flex');
        }

        async function procesarCobro(metodoPago) {
    cerrarModalCobro();
    const btn = document.getElementById('btnCobrar');
    btn.disabled = true;

    const ahora = new Date();
    const year = ahora.getFullYear();
    const month = String(ahora.getMonth() + 1).padStart(2, '0');
    const day = String(ahora.getDate()).padStart(2, '0');
    const hours = String(ahora.getHours()).padStart(2, '0');
    const minutes = String(ahora.getMinutes()).padStart(2, '0');
    const seconds = String(ahora.getSeconds()).padStart(2, '0');
    const fechaHoraLocal = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;

    const payload = {
        id_comerciante: comercianteData.id,
        tipo: 'INGRESO',
        monto: ventaActual.total,
        metodo: metodoPago,
        descripcion: ventaActual.items.map((item, i) => `${i+1}. ${item.descripcion}: $${item.monto.toFixed(2)}`).join(', '),
        fecha_hora: fechaHoraLocal
    };

    try {
        await fetch(WEBHOOKS.GUARDAR, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        // ‚úÖ Si llega aqu√≠ sin error = √âXITO
        crearConfetti();
        mostrarNotificacion(`‚úÖ Venta guardada (${metodoPago})`, 'success');
        ventaActual = { items: [], total: 0 };
        limpiarVentaTemporal();
        actualizarDisplayTotal();
        actualizarListaItems();
        setTimeout(showMenuScreen, 1500);
        
    } catch (error) {
        console.error('Error:', error);
        mostrarNotificacion('‚ùå Error de conexi√≥n', 'error');
    } finally {
        btn.disabled = false;
    }
}

        // --- GASTOS LOGIC ---
        async function guardarGasto() {
            const monto = parseFloat(document.getElementById('montoGasto').value);
            const cat = document.getElementById('categoriaGasto').value;
            const desc = document.getElementById('descripcionGasto').value;

            if (!monto || !cat) { mostrarNotificacion('‚ö†Ô∏è Completa monto y categor√≠a', 'error'); return; }

            const btn = document.getElementById('btnGuardarGasto');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> GUARDANDO...';
            btn.disabled = true;

            const payload = {
                id_comerciante: comercianteData.id,
                tipo: 'GASTO',
                monto: monto,
                categoria: cat,
                descripcion: desc || `Gasto: ${cat}`,
                fecha_hora: new Date().toISOString()
            };

            try {
                await fetch(WEBHOOKS.GUARDAR, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                mostrarNotificacion('‚úÖ Gasto guardado', 'success');
                document.getElementById('montoGasto').value = '';
                document.getElementById('descripcionGasto').value = '';
                setTimeout(showMenuScreen, 1500);
            } catch (e) {
                mostrarNotificacion('‚ùå Error al guardar gasto', 'error');
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-save"></i> GUARDAR GASTO';
                btn.disabled = false;
            }
        }

        // --- HISTORIAL & CHART LOGIC ---
        async function cargarHistorial() {
            const container = document.getElementById('transactionsContainer');
            if (!comercianteData.id) return;

            container.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin text-3xl mb-2"></i><p>Cargando datos...</p></div>';

            try {
                const { fechaDesde, fechaHasta } = obtenerRangoFechas(filtroActual);
                // ORIGINAL URL STRUCTURE: ?comercio_id=X&fecha_desde=Y&fecha_hasta=Z
                const url = `${WEBHOOKS.HISTORIAL}?comercio_id=${comercianteData.id}&fecha_desde=${fechaDesde}&fecha_hasta=${fechaHasta}`;
                const response = await fetch(url);
                const data = await response.json();

                // Handle different response structures gracefully
                transaccionesData = data.transacciones || data || [];
                renderHistorial(transaccionesData);
                updateBalanceChart(transaccionesData);
            } catch (error) {
                console.error('Error Historial:', error);
                container.innerHTML = '<div class="text-center text-red-500 py-10">Error al cargar historial</div>';
            }
        }

        function cambiarFiltro(filtro) {
            filtroActual = filtro;
            document.querySelectorAll('.filter-tab').forEach(b => {
                b.classList.remove('bg-gray-700', 'text-white', 'shadow');
                b.classList.add('text-gray-400');
                if (b.dataset.filter === filtro) {
                    b.classList.add('bg-gray-700', 'text-white', 'shadow');
                    b.classList.remove('text-gray-400');
                }
            });
            // Reload from server with new dates
            cargarHistorial();
        }

        function obtenerRangoFechas(filtro) {
            const ahora = new Date();
            let fechaDesde = new Date();

            if (filtro === 'semana') {
                fechaDesde.setDate(ahora.getDate() - 7);
            } else if (filtro === 'mes') {
                fechaDesde.setMonth(ahora.getMonth() - 1);
            } else if (filtro === 'a√±o') {
                fechaDesde.setFullYear(ahora.getFullYear() - 1);
            }

            // Helpers for YYYY-MM-DD
            const format = (d) => d.toISOString().split('T')[0];
            return {
                fechaDesde: format(fechaDesde),
                fechaHasta: format(ahora)
            };
        }

        // Removed client-side aplicarFiltro since we fetch filtered data now
        // But keeping placeholder if something calls it, merging into cargarHistorial
        function aplicarFiltro(periodo) {
            cambiarFiltro(periodo);
        }

        // Helper to safely parse dates
        function safeDate(dateStr) {
            if (!dateStr) return 'Fecha inv√°lida';
            // Try standard parser
            const d = new Date(dateStr);
            if (!isNaN(d.getTime())) return d.toLocaleString();
            // If failed, return simpler string or original
            // Sometimes it comes as YYYY-MM-DD HH:mm:ss directly
            return dateStr.substring(0, 16).replace('T', ' ');
        }

        function renderHistorial(datos) {
            const container = document.getElementById('transactionsContainer');
            // Calculate totals
            let ingresos = 0, gastos = 0;
            datos.forEach(t => {
                if (t.tipo === 'INGRESO') ingresos += parseFloat(t.monto);
                if (t.tipo === 'GASTO') gastos += parseFloat(t.monto);
            });

            document.getElementById('totalIngresos').textContent = `$ ${ingresos.toFixed(2)}`;
            document.getElementById('totalGastos').textContent = `$ ${gastos.toFixed(2)}`;
            document.getElementById('balanceTotal').textContent = `$ ${(ingresos - gastos).toFixed(2)}`;

            if (datos.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No hay movimientos en este periodo</p>';
                return;
            }

            container.innerHTML = datos.map((t, i) => `
                <div class="glass-panel p-4 rounded-xl border border-gray-700/50 flex flex-col md:flex-row items-center justify-between group hover:border-gray-500 transition-colors gap-4">
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${t.tipo === 'INGRESO' ? 'bg-primary/10 text-primary' : 'bg-warning/10 text-warning'}">
                             <i class="fa-solid ${t.tipo === 'INGRESO' ? 'fa-arrow-down' : 'fa-arrow-up'} text-xl"></i>
                        </div>
                        <div>
                            <div class="font-bold text-white text-lg">${t.descripcion || 'Sin descripci√≥n'}</div>
                            <div class="text-sm text-gray-400 mt-1">
                                <i class="fa-regular fa-clock mr-1"></i>
                                ${safeDate(t.fecha_hora || t.created_at)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-right w-full md:w-auto flex flex-col md:items-end gap-2">
                        <div class="font-mono font-bold text-2xl ${t.tipo === 'INGRESO' ? 'text-primary' : 'text-warning'}">
                            ${t.tipo === 'INGRESO' ? '+' : '-'} $${parseFloat(t.monto).toFixed(2)}
                        </div>
                        <div class="flex gap-3 justify-end">
                            <button onclick="editarTransaccion('${t.id}')" 
                                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-blue-500/10 text-blue-400 border border-blue-500/20 hover:bg-blue-500 hover:text-white transition-all text-xs font-bold uppercase tracking-wider">
                                <i class="fa-solid fa-pen"></i> Editar
                            </button>
                            <button onclick="eliminarTransaccion('${t.id}')" 
                                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500 hover:text-white transition-all text-xs font-bold uppercase tracking-wider">
                                <i class="fa-solid fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- EDIT & DELETE LOGIC (Restored) ---
        function editarTransaccion(id) {
            const tx = transaccionesData.find(t => t.id === id);
            if (!tx) return;

            transaccionEditando = id;
            document.getElementById('editMonto').value = tx.monto;
            document.getElementById('editDescripcion').value = tx.descripcion;

            document.getElementById('modalEdit').classList.remove('hidden');
            document.getElementById('modalEdit').classList.add('flex');
        }

        function cerrarModalEdit() {
            document.getElementById('modalEdit').classList.add('hidden');
            document.getElementById('modalEdit').classList.remove('flex');
            transaccionEditando = null;
        }

        async function guardarEdicion() {
            if (!transaccionEditando) return;

            const monto = parseFloat(document.getElementById('editMonto').value);
            const desc = document.getElementById('editDescripcion').value;

            if (!monto) { mostrarNotificacion('‚ö†Ô∏è Monto inv√°lido', 'error'); return; }

            try {
                // Call Edit Webhook
                await fetch(WEBHOOKS.EDITAR, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: transaccionEditando,
                        monto: monto,
                        descripcion: desc,
                        comercio_id: comercianteData.id
                    })
                });

                mostrarNotificacion('‚úÖ Actualizado correctamente', 'success');
                cerrarModalEdit();
                cargarHistorial(); // Reload list
            } catch (e) {
                console.error(e);
                mostrarNotificacion('‚ùå Error: ' + (e.message || 'Error al actualizar'), 'error');
            }
        }

        async function eliminarTransaccion(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta transacci√≥n?')) return;

            try {
                await fetch(WEBHOOKS.ELIMINAR, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: id,
                        comercio_id: comercianteData.id
                    })
                });

                mostrarNotificacion('üóëÔ∏è Transacci√≥n eliminada', 'success');
                cargarHistorial(); // Reload list
            } catch (e) {
                console.error(e);
                mostrarNotificacion('‚ùå Error: ' + (e.message || 'Error al eliminar'), 'error');
            }
        }

        // --- CHART JS ---
        function updateBalanceChart(datos) {
            let ingresos = 0, gastos = 0;
            datos.forEach(t => {
                if (t.tipo === 'INGRESO') ingresos += parseFloat(t.monto);
                if (t.tipo === 'GASTO') gastos += parseFloat(t.monto);
            });

            const ctx = document.getElementById('balanceChart').getContext('2d');

            if (balanceChart) {
                balanceChart.destroy();
            }

            balanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ingresos', 'Gastos'],
                    datasets: [{
                        label: 'Balance',
                        data: [ingresos, gastos],
                        backgroundColor: ['#10b981', '#ef4444'], // Primary, Warning
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#334155',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#fff' }
                        }
                    }
                }
            });
        }

        // --- UTILS ---
        function mostrarNotificacion(msg, type) {
            const notif = document.getElementById('notification');
            const icon = document.getElementById('notifIcon');
            const text = document.getElementById('notifMessage');

            text.textContent = msg;
            notif.classList.remove('hidden', 'border-primary', 'border-warning', 'border-red-500');

            // Colors
            if (type === 'success') { notif.classList.add('bg-gray-800', 'text-white', 'border-primary'); icon.innerHTML = '‚úÖ'; }
            if (type === 'error') { notif.classList.add('bg-gray-800', 'text-white', 'border-red-500'); icon.innerHTML = '‚ùå'; }
            if (type === 'warning') { notif.classList.add('bg-gray-800', 'text-white', 'border-warning'); icon.innerHTML = '‚ö†Ô∏è'; }

            notif.classList.remove('translate-x-[150%]');
            setTimeout(() => notif.classList.add('translate-x-[150%]'), 3000);
        }

        function crearConfetti() {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#10b981', '#3b82f6', '#f59e0b'] });
        }

        // --- LOCAL STORAGE HELPERS (Keep session alive) ---
        function guardarVentaTemporal() { localStorage.setItem('venta_temp', JSON.stringify(ventaActual)); }
        function cargarVentaGuardada() {
            const saved = localStorage.getItem('venta_temp');
            if (saved) {
                ventaActual = JSON.parse(saved);
                contadorProductos = ventaActual.items.length + 1;
                actualizarDisplayTotal();
                actualizarListaItems();
            }
        }
        function limpiarVentaTemporal() { localStorage.removeItem('venta_temp'); }

        // --- CUSTOM SELECT LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const trigger = document.getElementById('selectTrigger');
            const options = document.getElementById('customOptions');
            const hiddenInput = document.getElementById('categoriaGasto');
            const selectedText = document.getElementById('selectedText');

            if (trigger) {
                trigger.addEventListener('click', () => options.classList.toggle('hidden'));

                document.querySelectorAll('.custom-option').forEach(opt => {
                    opt.addEventListener('click', function () {
                        const val = this.dataset.value;
                        hiddenInput.value = val;
                        selectedText.textContent = this.textContent;
                        selectedText.classList.remove('text-gray-400');
                        selectedText.classList.add('text-white');
                        options.classList.add('hidden');
                    });
                });

                // Close when clicking outside
                document.addEventListener('click', (e) => {
                    if (!trigger.contains(e.target) && !options.contains(e.target)) {
                        options.classList.add('hidden');
                    }
                });
            }
        });

        // --- GLOBAL EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function () {
            // SALES LISTENERS
            const montoInput = document.getElementById('montoInput');
            const descInput = document.getElementById('descripcionInput');
            const btnCheckMonto = document.getElementById('btnCheckMonto');

            if (montoInput) {
                montoInput.addEventListener('keyup', function (e) {
                    if (e.key === 'Enter') {
                        if (this.value && parseFloat(this.value) > 0) {
                            agregarItem();
                        }
                    }
                });

                // Mobile Button Logic
                montoInput.addEventListener('focus', () => {
                    if (window.innerWidth < 768 && btnCheckMonto) btnCheckMonto.classList.remove('hidden');
                });
                montoInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        if (window.innerWidth < 768 && btnCheckMonto) btnCheckMonto.classList.add('hidden');
                    }, 200);
                });
            }

            if (descInput) {
                descInput.addEventListener('keyup', function (e) {
                    if (e.key === 'Enter') {
                        if (montoInput && montoInput.value && parseFloat(montoInput.value) > 0) {
                            agregarItem();
                        } else {
                            montoInput.focus();
                        }
                    }
                });
            }

            // GASTOS LISTENERS
            const montoGasto = document.getElementById('montoGasto');
            const btnCheckGasto = document.getElementById('btnCheckGasto');

            if (montoGasto) {
                montoGasto.addEventListener('keyup', function (e) {
                    if (e.key === 'Enter') {
                        const cat = document.getElementById('categoriaGasto').value;
                        if (this.value && parseFloat(this.value) > 0) {
                            if (cat) guardarGasto();
                            else mostrarNotificacion('‚ö†Ô∏è Selecciona categor√≠a', 'error');
                        }
                    }
                });

                montoGasto.addEventListener('focus', () => {
                    if (window.innerWidth < 768 && btnCheckGasto) btnCheckGasto.classList.remove('hidden');
                });
                montoGasto.addEventListener('blur', () => {
                    setTimeout(() => {
                        if (window.innerWidth < 768 && btnCheckGasto) btnCheckGasto.classList.add('hidden');
                    }, 200);
                });
            }
        });
    </script>
</body>

</html>
