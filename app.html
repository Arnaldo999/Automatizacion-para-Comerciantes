<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üè™ POS - Almac√©n Dashboard</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.png">
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@700;900&display=swap"
        rel="stylesheet">
    <!-- n8n Chat CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- LIBRER√çA ESC√ÅNER C√ìDIGO DE BARRAS -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        card: '#1e293b',
                        primary: '#3b82f6',
                        secondary: '#6366f1',
                        accent: '#8b5cf6',
                        warning: '#ef4444',
                        gold: '#f59e0b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Orbitron', 'monospace'],
                    }
                }
            }
        }
    </script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .screen.active {
            display: block;
            opacity: 1;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .mobile-bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        .btn-check-mobile {
            display: none;
        }

        .search-result-item.selected {
            background-color: rgba(59, 130, 246, 0.2) !important;
            border-left: 4px solid #3b82f6;
        }

        @media (max-width: 768px) {
            #inventario-screen thead {
                display: none !important;
            }

            #listaInventario {
                display: block;
                width: 100%;
            }

            #listaInventario tr {
                display: block;
                margin-bottom: 1.5rem;
                background: rgba(30, 41, 59, 0.4);
                border-radius: 1.5rem;
                padding: 1.25rem;
                border: 1px solid rgba(255, 255, 255, 0.08);
                width: 100%;
                box-sizing: border-box;
            }

            #listaInventario td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.03);
                text-align: right;
                width: 100%;
            }

            #listaInventario td:last-child {
                border-bottom: 0;
                margin-top: 1rem;
                padding-top: 1.25rem;
                justify-content: center;
                gap: 1rem;
            }

            #listaInventario td::before {
                content: attr(data-label);
                font-weight: 800;
                color: #94a3b8;
                font-size: 0.7rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                margin-right: 1.5rem;
                text-align: left;
                flex-shrink: 0;
            }
        }

        /* Ocultar por defecto para controlarlo con JS */
.n8n-chat-widget {
    display: none;
}
    </style>
</head>

<body class="bg-dark text-gray-100 font-sans h-screen overflow-hidden flex">

    <!-- SIDEBAR (Desktop) -->
    <!-- SIDEBAR (Desktop) -->
    <aside
        class="hidden md:flex flex-col w-64 bg-card border-r border-gray-800 absolute inset-y-0 left-0 z-50 overflow-y-auto custom-scrollbar">
        <div class="p-6 border-b border-gray-800 text-center flex flex-col items-center gap-3">
            <img src="logo.png" alt="POS Logo" class="w-16 h-16 object-contain rounded-xl">
            <div>
                <h1 class="text-2xl font-bold text-primary tracking-wider">POS SYSTEM</h1>
                <p class="text-xs text-gray-400 mt-1">Gesti√≥n Comercial 360</p>
            </div>
        </div>

        <div class="p-4">
            <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700/50 mb-6">
                <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Usuario</p>
                <div id="sidebarUserName" class="text-primary font-bold text-lg truncate">Cargando...</div>
                <div class="text-xs text-gray-500 mt-1">ID: <span id="sidebarUserId">---</span></div>
            </div>

            <!-- MENU DESKTOP (Sidebar) -->
            <nav class="space-y-2">
                <button onclick="showMenuScreen()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors text-left text-gray-300 hover:text-white">
                    <i class="fa-solid fa-house text-lg w-6 text-center"></i>
                    <span>Inicio</span>
                </button>
                <button onclick="showVentasScreen()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors text-left text-gray-300 hover:text-white">
                    <i class="fa-solid fa-cash-register text-lg w-6 text-center text-primary"></i>
                    <span>Nueva Venta</span>
                </button>
                <button onclick="showGastosScreen()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors text-left text-gray-300 hover:text-white">
                    <i class="fa-solid fa-money-bill-transfer text-lg w-6 text-center text-warning"></i>
                    <span>Registrar Gasto</span>
                </button>
                <button onclick="showHistorialScreen()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors text-left text-gray-300 hover:text-white">
                    <i class="fa-solid fa-chart-line text-lg w-6 text-center text-secondary"></i>
                    <span>Historial</span>
                </button>
                <button onclick="showInventarioScreen()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors text-left text-gray-300 hover:text-white">
                    <i class="fa-solid fa-boxes-stacked text-lg w-6 text-center text-gold"></i>
                    <span>Inventario</span>
                </button>
                <button onclick="showConfigScreen()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors text-left text-gray-300 hover:text-white">
                    <i class="fa-solid fa-gear text-lg w-6 text-center text-accent"></i>
                    <span>Configuraci√≥n</span>
                </button>
            </nav>
        </div>


    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative md:ml-64 w-full">

        <!-- MENU MOVIL (Bottom Navigation) -->
        <nav
            class="md:hidden fixed bottom-0 left-0 right-0 bg-dark/95 backdrop-blur-xl border-t border-gray-800 flex justify-between px-6 py-3 z-40 pb-safe shadow-[0_-4px_20px_rgba(0,0,0,0.3)] animate-slide-up">
            <button onclick="showMenuScreen()"
                class="flex flex-col items-center justify-center text-primary group transition-all transform hover:scale-110 active:scale-95">
                <div class="relative p-1 rounded-xl group-hover:bg-primary/10 transition-colors">
                    <i class="fa-solid fa-house text-xl mb-1"></i>
                </div>
                <span class="text-[10px] font-medium tracking-wide">Inicio</span>
            </button>
            <button onclick="showVentasScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white group transition-all transform hover:scale-110 active:scale-95">
                <div class="relative p-1 rounded-xl group-hover:bg-gray-700 transition-colors">
                    <i class="fa-solid fa-store text-xl mb-1"></i>
                </div>
                <span class="text-[10px] font-medium tracking-wide">Vender</span>
            </button>
            <button onclick="showGastosScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white group transition-all transform hover:scale-110 active:scale-95">
                <div class="relative p-1 rounded-xl group-hover:bg-gray-700 transition-colors">
                    <i class="fa-solid fa-money-bill-transfer text-xl mb-1"></i>
                </div>
                <span class="text-[10px] font-medium tracking-wide">Gastos</span>
            </button>
            <button onclick="showInventarioScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white group transition-all transform hover:scale-110 active:scale-95">
                <div class="relative p-1 rounded-xl group-hover:bg-gray-700 transition-colors">
                    <i class="fa-solid fa-boxes-stacked text-xl mb-1"></i>
                </div>
                <span class="text-[10px] font-medium tracking-wide">Stock</span>
            </button>
            <button onclick="showConfigScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white group transition-all pl-2 border-l border-gray-700/50 transform hover:scale-110 active:scale-95">
                <div class="relative p-1 rounded-xl group-hover:bg-gray-700 transition-colors">
                    <i class="fa-solid fa-gear text-xl mb-1 animate-spin-slow-hover"></i>
                </div>
                <span class="text-[10px] font-medium tracking-wide">Config</span>
            </button>
        </nav>

        <!-- MOBILE HEADER -->
        <!-- MOBILE HEADER -->
        <header
            class="md:hidden flex items-center justify-between p-4 bg-card/90 backdrop-blur border-b border-gray-800 sticky top-0 z-40">
            <!-- Left: Logo & Title & Name -->
            <div class="flex items-center gap-2 overflow-hidden flex-1">
                <img src="logo.png" alt="Logo" class="w-8 h-8 object-contain rounded-lg flex-shrink-0">
                <div class="flex flex-col">
                    <div class="flex items-center gap-2">
                        <span class="text-primary text-xl font-bold leading-none">POS</span>
                        <div id="statusIndicator" class="flex items-center gap-1">
                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            <span class="text-[10px] text-green-500 font-medium">Online</span>
                        </div>
                    </div>
                    <!-- Nombre del local restaurado -->
                    <div id="headerUserName"
                        class="text-xs text-gray-300 font-medium truncate max-w-[120px] leading-tight">...</div>
                </div>
            </div>

            <!-- Right: ID & Profile -->
            <div class="flex items-center gap-3">
                <div class="text-xs text-gray-400 font-medium">ID: <span id="headerUserId"
                        class="text-gray-200">...</span></div>

                <!-- Mobile Profile Button -->
                <button onclick="abrirPerfil()"
                    class="w-8 h-8 rounded-full bg-gradient-to-tr from-primary to-secondary p-[1px] shadow-lg shadow-primary/20">
                    <div class="w-full h-full rounded-full bg-gray-900 overflow-hidden">
                        <img id="mobileHeaderProfileImg" src="https://ui-avatars.com/api/?name=User&background=random"
                            class="w-full h-full object-cover">
                    </div>
                </button>
            </div>
        </header>

        <!-- CONTENT AREA -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative pb-28 md:pb-8">

            <!-- MENU SCREEN -->
            <!-- ‚úÖ PERFIL DE USUARIO MOVIDO FUERA DEL CONTENEDOR LIMITADO -->
            <!-- Lo ponemos fixed o absolute relativo al main para que se pegue a la derecha real -->
            <!-- Ajuste M√≥vil: OCULTO (hidden) pues ya est√° en el header, Escritorio: top-4 -->
            <div id="perfil-btn-container"
                class="hidden md:block absolute md:top-4 z-50 md:right-8 transition-opacity duration-300">
                <button onclick="abrirPerfil()" class="group flex items-center gap-3 focus:outline-none">
                    <div class="text-right hidden sm:block">
                        <p id="miniPerfilNombre" class="text-xs font-bold text-white leading-tight">Cargando...</p>
                        <p class="text-[10px] text-primary">Ver Perfil</p>
                    </div>
                    <div
                        class="w-12 h-12 rounded-full p-[2px] bg-gradient-to-tr from-primary to-secondary cursor-pointer shadow-lg shadow-primary/20 hover:scale-105 transition-transform duration-300">
                        <div class="w-full h-full rounded-full bg-gray-900 border-2 border-gray-900 overflow-hidden">
                            <img id="profileImageBtn" src="https://ui-avatars.com/api/?name=User&background=random"
                                alt="Perfil" class="w-full h-full object-cover">
                        </div>
                    </div>
                </button>
            </div>

            <!-- MENU SCREEN -->
            <div id="menu-screen" class="screen active max-w-4xl mx-auto relative">

                <!-- ‚úÖ HERO SECTION & MENU LAYOUT -->
                <!-- ‚úÖ OPTIMIZACION: Mayor compactaci√≥n (gap-3, min-h reducida) -->
                <!-- Agregamos pt-6 en m√≥vil para separar del header, y mantenemos lg:pt-12 en escritorio -->
                <div
                    class="pt-6 lg:pt-12 flex flex-col lg:flex-row gap-3 items-stretch justify-center h-full lg:h-auto min-h-[400px]">

                    <!-- COLUMN 1: MEN√ö (55%) -->
                    <!-- ‚úÖ OPTIMIZACION: space-y reducido a 4 -->
                    <div class="w-full lg:w-[55%] flex flex-col justify-center space-y-4 animate-slide-up">

                        <!-- Header -->
                        <div class="text-left space-y-1 pl-2">
                            <!-- ‚úÖ OPTIMIZACION: T√≠tulo m√°s peque√±o (2xl/3xl) -->
                            <h1 class="text-2xl md:text-3xl font-bold text-white tracking-tight">
                                Gesti√≥n <span
                                    class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">Comercial
                                    360¬∞</span>
                            </h1>
                            <p class="text-gray-400 text-sm max-w-lg">Controla tus ventas, inventario y gastos desde un
                                solo lugar.</p>
                        </div>

                        <!-- Grid de Botones -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <!-- Ventas -->
                            <div onclick="showVentasScreen()"
                                class="glass-panel p-4 rounded-2xl cursor-pointer group hover:bg-gray-800/80 transition-all border border-gray-700 hover:border-primary/50 relative overflow-hidden flex flex-col justify-end min-h-[140px]">
                                <div
                                    class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <i class="fa-solid fa-cash-register text-4xl text-primary"></i>
                                </div>
                                <div
                                    class="w-10 h-10 rounded-xl bg-primary/20 flex items-center justify-center text-primary text-lg mb-2 group-hover:scale-110 transition-transform flex-shrink-0">
                                    <i class="fa-solid fa-sack-dollar"></i>
                                </div>
                                <h3 class="text-base font-bold text-white mb-0.5 break-words line-clamp-1">Nueva Venta
                                </h3>
                                <p class="text-[10px] text-gray-400 leading-tight">Registrar venta y cobro</p>
                            </div>

                            <!-- Gastos -->
                            <div onclick="showGastosScreen()"
                                class="glass-panel p-4 rounded-2xl cursor-pointer group hover:bg-gray-800/80 transition-all border border-gray-700 hover:border-red-500/50 relative overflow-hidden flex flex-col justify-end min-h-[140px]">
                                <div
                                    class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <i class="fa-solid fa-file-invoice-dollar text-4xl text-red-500"></i>
                                </div>
                                <div
                                    class="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center text-red-500 text-lg mb-2 group-hover:scale-110 transition-transform flex-shrink-0">
                                    <i class="fa-solid fa-chart-simple"></i>
                                </div>
                                <h3 class="text-base font-bold text-white mb-0.5 break-words line-clamp-1">Registrar
                                    Gasto</h3>
                                <p class="text-[10px] text-gray-400 leading-tight">Salida de dinero</p>
                            </div>

                            <!-- Historial -->
                            <div onclick="showHistorialScreen()"
                                class="glass-panel p-4 rounded-2xl cursor-pointer group hover:bg-gray-800/80 transition-all border border-gray-700 hover:border-blue-500/50 relative overflow-hidden flex flex-col justify-end min-h-[140px]">
                                <div
                                    class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <i class="fa-solid fa-calendar-days text-4xl text-blue-500"></i>
                                </div>
                                <div
                                    class="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center text-blue-500 text-lg mb-2 group-hover:scale-110 transition-transform flex-shrink-0">
                                    <i class="fa-solid fa-chart-line"></i>
                                </div>
                                <h3 class="text-base font-bold text-white mb-0.5 break-words line-clamp-1">Historial
                                </h3>
                                <p class="text-[10px] text-gray-400 leading-tight">Balance y movimientos</p>
                            </div>

                            <!-- Inventario -->
                            <div onclick="showInventarioScreen()"
                                class="glass-panel p-4 rounded-2xl cursor-pointer group hover:bg-gray-800/80 transition-all border border-gray-700 hover:border-gold/50 relative overflow-hidden flex flex-col justify-end min-h-[140px]">
                                <div
                                    class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <i class="fa-solid fa-boxes text-4xl text-gold"></i>
                                </div>
                                <div
                                    class="w-10 h-10 rounded-xl bg-yellow-500/20 flex items-center justify-center text-gold text-lg mb-2 group-hover:scale-110 transition-transform flex-shrink-0">
                                    <i class="fa-solid fa-box"></i>
                                </div>
                                <h3 class="text-base font-bold text-white mb-0.5 break-words line-clamp-1">Inventario
                                </h3>
                                <p class="text-[10px] text-gray-400 leading-tight">Stock y productos</p>
                            </div>
                        </div>

                        <!-- ‚úÖ FOOTER INFO (Moved from Sidebar) -->
                        <div class="pt-4 mt-auto text-left space-y-1 border-t border-gray-800/50">
                            <div class="text-[10px] text-gray-400">Tel√©fono: +543765384843 Soporte</div>
                            <div class="text-[10px] text-secondary truncate">Web: arnaldoayalaestratega.com</div>
                            <div class="text-[10px] text-gray-500 leading-tight">
                                ¬© 2024 Todos los derechos reservados - T√©rminos y Condiciones
                            </div>
                        </div>
                    </div>

                    <!-- COLUMN 2: IMAGEN ATRACTIVA (45% - Aumentado) -->
                    <!-- ‚úÖ OPTIMIZACI√ìN: min-h reducido a 500px, p-10 reducida a p-8 -->
                    <div class="hidden lg:block w-[45%] relative animate-fade-in delay-100 min-h-[400px]">
                        <div
                            class="absolute inset-0 rounded-3xl overflow-hidden shadow-2xl border border-gray-700/50 group h-full">
                            <!-- Nueva Imagen: M√°s gen√©rica y oscura para mejor contraste -->
                            <img src="https://images.unsplash.com/photo-1556740758-90de374c12ad?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80"
                                alt="Comercio"
                                class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-700 brightness-75 group-hover:brightness-100">

                            <!-- Overlay Gradiente -->
                            <div
                                class="absolute inset-0 bg-gradient-to-t from-dark via-dark/30 to-transparent opacity-90">
                            </div>

                            <!-- Contenido sobre la imagen -->
                            <div class="absolute bottom-0 left-0 p-8 w-full">
                                <div
                                    class="mb-3 inline-block px-3 py-1 rounded-full bg-primary/90 backdrop-blur-md text-dark text-[10px] font-extra-bold uppercase tracking-wider shadow-lg shadow-primary/20">
                                    ‚ú® Tip del d√≠a
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-2 leading-tight drop-shadow-lg">
                                    "El orden trae prosperidad."
                                </h3>
                                <p class="text-white/90 text-sm font-medium leading-relaxed max-w-sm drop-shadow-md">
                                    Mant√©n tu stock al d√≠a para nunca perder una venta importante.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VENTAS SCREEN -->
            <div id="ventas-screen" class="screen max-w-6xl mx-auto pb-44 md:pb-0">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="cancelarVenta()"
                        class="md:hidden flex items-center text-gray-400 hover:text-white">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Volver
                    </button>
                    <div class="flex items-center gap-3">
                        <h2 class="text-2xl font-bold text-primary flex items-center gap-2">
                            <i class="fa-solid fa-cart-shopping"></i> Nueva Venta
                        </h2>
                        <!-- ‚úÖ Nuevo Bot√≥n Refrescar Inventario en Ventas -->
                        <button onclick="cargarInventario(true)"
                            class="text-gray-400 hover:text-white transition-colors" title="Actualizar Inventario">
                            <i class="fa-solid fa-sync"></i>
                        </button>
                    </div>
                    <div class="hidden md:block"></div>
                </div>

                <div class="flex flex-col md:flex-row gap-6">
                    <!-- Left Column: Products & Search -->
                    <div class="flex-1 space-y-6">
                        <!-- Input Section (Larger Search) -->
                        <div class="glass-panel rounded-2xl p-6">

                            <!-- ‚úÖ SECCI√ìN DE B√öSQUEDA Y ESCANEO EN VENTAS -->
                            <div class="mb-4">
                                <div class="flex gap-2">
                                    <div class="relative flex-1">
                                        <i
                                            class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                        <!-- onkeydown detecta Enter (USB scanner o teclado) para agregar r√°pido -->
                                        <input type="text" id="descripcionInput" oninput="buscarProductos(this.value)"
                                            onkeydown="if(event.key === 'Enter'){ handleVentasEnter(this.value); }"
                                            class="w-full bg-dark/50 border border-gray-600 rounded-2xl pl-12 pr-12 py-4 text-white text-lg focus:outline-none focus:border-primary transition-all"
                                            placeholder="Buscar producto o Escanear...">

                                        <button id="btnClearSearch" onclick="limpiarBuscador()"
                                            class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white hidden">
                                            <i class="fa-solid fa-times text-xl"></i>
                                        </button>
                                    </div>
                                    <!-- Bot√≥n Esc√°ner Ventas -->
                                    <button type="button" onclick="toggleScanner('ventas')"
                                        class="bg-gray-700 hover:bg-gray-600 text-white px-5 rounded-2xl transition-colors flex items-center justify-center border border-gray-600">
                                        <i class="fa-solid fa-barcode text-2xl"></i>
                                    </button>
                                </div>

                                <!-- Contenedor de la c√°mara Ventas -->
                                <div id="reader-ventas"
                                    class="hidden w-full rounded-xl overflow-hidden border-2 border-primary mt-2"></div>

                                <!-- Resultados de b√∫squeda -->
                                <div id="productosResultados"
                                    class="hidden z-30 w-full mt-2 bg-gray-800 border border-gray-600 rounded-xl shadow-2xl max-h-80 overflow-y-auto">
                                </div>
                            </div>

                            <!-- Campos de Cantidad y Precio -->
                            <div class="grid grid-cols-2 gap-4 items-end">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Cantidad</label>
                                    <input type="number" inputmode="numeric" id="cantidadInput" value="1" min="1"
                                        oninput="actualizarTotalItem()"
                                        class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white text-xl font-bold focus:outline-none focus:border-secondary"
                                        placeholder="1">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Precio Unitario
                                        ($)</label>
                                    <input type="text" inputmode="decimal" id="montoInput"
                                        oninput="actualizarTotalItem()"
                                        class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white text-xl font-bold focus:outline-none focus:border-primary"
                                        placeholder="0.00">
                                </div>
                            </div>

                            <!-- Total del Item Calculado -->
                            <div class="mt-4 p-4 bg-primary/10 rounded-lg border border-primary/30">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-300 font-bold">Total Item:</span>
                                    <span id="totalItemDisplay" class="text-2xl font-mono font-bold text-primary">$
                                        0.00</span>
                                </div>
                            </div>

                            <button onclick="agregarItem()"
                                class="h-[52px] bg-gradient-to-r from-primary to-blue-600 hover:from-blue-600 hover:to-primary text-white font-bold rounded-lg flex items-center justify-center gap-2 transition-all shadow-lg">
                                <i class="fa-solid fa-plus"></i> Agregar Item
                            </button>
                        </div>
                    </div>

                    <!-- Right Column: Sidebar Ticket -->
                    <div class="w-full md:w-80 space-y-6">
                        <div class="glass-panel rounded-2xl p-6 h-fit bg-card/40 flex flex-col">
                            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700/50">
                                <h3 class="font-bold text-gray-100 flex items-center gap-2">
                                    <i class="fa-solid fa-receipt text-primary"></i> Ticket Actual
                                </h3>
                                <button onclick="cancelarVenta()"
                                    class="text-[10px] text-gray-500 hover:text-red-400 uppercase font-bold">Limpiar</button>
                            </div>

                            <div id="itemsList" class="space-y-3 min-h-[200px] max-h-[400px] overflow-y-auto mb-6 pr-1">
                                <div class="text-center py-12 text-gray-500">
                                    <i class="fa-solid fa-basket-shopping text-4xl mb-3 opacity-20 block mx-auto"></i>
                                    <p class="text-sm">Carrito vac√≠o</p>
                                </div>
                            </div>

                            <div class="mt-auto pt-4 border-t border-gray-700/50 space-y-4">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-400">Subtotal</span>
                                    <span id="subtotalDisplay" class="text-gray-300">$ 0.00</span>
                                </div>
                                <div class="flex justify-between items-end">
                                    <span class="text-gray-400 font-bold uppercase text-xs">Total a Pagar</span>
                                    <div id="totalDisplay" class="text-4xl font-mono font-black text-white">$ 0.00
                                    </div>
                                </div>
                                <button id="btnCobrar" onclick="mostrarModalCobro()" disabled
                                    class="w-full bg-gradient-to-r from-primary to-blue-600 text-dark font-black text-lg py-4 rounded-2xl shadow-lg shadow-primary/20 disabled:opacity-50 disabled:grayscale transition-all active:scale-95 flex items-center justify-center gap-3">
                                    <i class="fa-solid fa-cash-register"></i>
                                    <span>COBRAR TICKET</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer Actions (Mobile Only) -->
                <div
                    class="md:hidden fixed bottom-0 left-0 w-full bg-dark/95 backdrop-blur-xl border-t border-gray-800 p-4 z-40 pb-20">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-gray-400 font-bold uppercase text-xs">Total a Pagar</span>
                        <div id="totalMobDisplay" class="text-4xl font-mono font-black text-white">$ 0.00</div>
                    </div>
                    <button id="btnCobrarMob" onclick="mostrarModalCobro()" disabled
                        class="w-full bg-primary text-dark font-black text-xl py-4 rounded-2xl shadow-lg shadow-primary/20 disabled:opacity-50">
                        COBRAR TICKET
                    </button>
                </div>
            </div>

            <!-- GASTOS SCREEN -->
            <div id="gastos-screen" class="screen max-w-lg mx-auto">
                <div class="flex items-center justify-between mb-8">
                    <button onclick="showMenuScreen()"
                        class="md:hidden flex items-center text-gray-400 hover:text-white">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Men√∫
                    </button>
                    <h2 class="text-2xl font-bold text-warning flex items-center gap-2">
                        <i class="fa-solid fa-file-invoice-dollar"></i> Registrar Gasto
                    </h2>
                    <div></div>
                </div>

                <div class="glass-panel rounded-2xl p-8 border border-warning/30">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Monto Gasto ($)</label>
                            <input type="text" inputmode="decimal" id="montoGasto"
                                class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-4 text-white text-2xl font-bold text-center focus:outline-none focus:border-warning"
                                placeholder="0.00">
                        </div>

                        <div>
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Categor√≠a</label>
                            <select id="categoriaGasto"
                                class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-warning">
                                <option value="">Seleccionar...</option>
                                <option value="Proveedores">Proveedores</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Alquiler">Alquiler</option>
                                <option value="Sueldos">Sueldos</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Detalle
                                (Opcional)</label>
                            <textarea id="descripcionGasto"
                                class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-warning resize-none h-24"
                                placeholder="Ej: Pago de luz..."></textarea>
                        </div>

                        <button id="btnGuardarGasto" onclick="guardarGasto()"
                            class="w-full bg-warning hover:bg-red-600 text-white font-bold text-lg py-4 rounded-xl flex items-center justify-center gap-2">
                            <i class="fa-solid fa-save"></i> GUARDAR GASTO
                        </button>
                    </div>
                </div>
            </div>

            <!-- HISTORIAL SCREEN -->
            <div id="historial-screen" class="screen max-w-4xl mx-auto pb-24 md:pb-0">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <div class="flex items-center gap-4">
                        <button onclick="showMenuScreen()"
                            class="md:hidden flex items-center text-gray-400 hover:text-white">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Men√∫
                        </button>
                        <h2 class="text-2xl font-bold text-secondary flex items-center gap-2">
                            <i class="fa-solid fa-list-check"></i> Historial
                        </h2>
                    </div>
                    <!-- Bot√≥n para abrir modal de reporte -->
                    <button onclick="abrirModalReporte()"
                        class="w-full md:w-auto bg-secondary/20 hover:bg-secondary text-secondary hover:text-dark px-4 py-3 md:py-2 rounded-lg font-bold transition-all flex items-center justify-center gap-2 text-xs">
                        <i class="fa-solid fa-file-export"></i> SOLICITAR REPORTE
                    </button>
                </div>

                <!-- Balance Cards (Visual Summary) -->
                <!-- ‚úÖ Estas tarjetas mostrar√°n los totales correspondientes al filtro activo (Hoy, Semana, Mes, A√±o) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div
                        class="col-span-1 md:col-span-3 bg-gradient-to-r from-gray-800 to-gray-900 border border-secondary/30 rounded-2xl p-6 text-center">
                        <div class="text-gray-400 text-sm font-bold uppercase tracking-widest mb-2">Balance Neto
                            (Ganancia)</div>
                        <div id="balanceTotal" class="text-4xl md:text-5xl font-mono font-bold text-white">$ 0.00</div>
                    </div>
                    <div class="bg-card/50 border border-primary/20 rounded-xl p-4 text-center">
                        <div class="text-xs text-gray-400 uppercase">Ingresos (Ventas)</div>
                        <div id="totalIngresos" class="text-2xl font-bold text-primary">$ 0.00</div>
                    </div>
                    <div class="bg-card/50 border border-warning/20 rounded-xl p-4 text-center">
                        <div class="text-xs text-gray-400 uppercase">Gastos</div>
                        <div id="totalGastos" class="text-2xl font-bold text-warning">$ 0.00</div>
                    </div>
                </div>

                <!-- Filters -->
                <div
                    class="flex justify-center p-1 bg-gray-800 rounded-lg mb-6 max-w-lg mx-auto overflow-x-auto scrollbar-none">
                    <button
                        class="filter-tab flex-1 py-2 px-3 rounded-md text-xs font-medium text-gray-400 whitespace-nowrap"
                        data-filter="hoy" onclick="cambiarFiltro('hoy')">Hoy</button>
                    <button
                        class="filter-tab flex-1 py-2 px-3 rounded-md text-xs font-medium text-gray-400 whitespace-nowrap"
                        data-filter="semana" onclick="cambiarFiltro('semana')">Esta Semana</button>
                    <button
                        class="filter-tab flex-1 py-2 px-3 rounded-md text-xs font-medium active bg-gray-700 text-white whitespace-nowrap"
                        data-filter="mes" onclick="cambiarFiltro('mes')">Este Mes</button>
                    <button
                        class="filter-tab flex-1 py-2 px-3 rounded-md text-xs font-medium text-gray-400 whitespace-nowrap"
                        data-filter="a√±o" onclick="cambiarFiltro('a√±o')">Este A√±o</button>
                </div>

                <!-- Transactions List -->
                <div id="transactionsContainer" class="space-y-3">
                    <div class="text-center py-10 text-secondary">
                        <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-2"></i>
                        <p>Cargando transacciones...</p>
                    </div>
                </div>
            </div>

            <!-- INVENTARIO SCREEN (ACTUALIZADO CON ESC√ÅNER Y COSTOS) -->
            <div id="inventario-screen" class="screen max-w-6xl mx-auto">
                <div class="flex items-center justify-between mb-8">
                    <button onclick="showMenuScreen()"
                        class="md:hidden flex items-center text-gray-400 hover:text-white">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Men√∫
                    </button>
                    <h2 class="text-2xl font-bold text-gold flex items-center gap-2">
                        <i class="fa-solid fa-boxes-stacked"></i> Inventario
                    </h2>
                    <div></div>
                </div>

                <!-- FORMULARIO CREAR PRODUCTO NUEVO -->
                <div class="glass-panel rounded-2xl p-6 mb-6">
                    <h3 class="text-gold font-bold mb-4 uppercase text-xs">Nuevo Producto</h3>

                    <!-- Secci√≥n Esc√°ner (Nuevo) -->
                    <div class="mb-5 space-y-2">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">C√≥digo de Barras</label>
                        <div class="flex gap-2">
                            <!-- MODIFICADO: Agregamos onkeydown para capturar el Enter del esc√°ner USB instant√°neamente -->
                            <input type="text" id="invCodigo"
                                onkeydown="if(event.key === 'Enter') { event.preventDefault(); verificarExistencia(this.value); }"
                                class="flex-1 bg-dark/50 border border-gray-600 rounded-xl px-4 py-3 text-white focus:border-gold focus:ring-1 focus:ring-gold outline-none transition-all"
                                placeholder="Escanea o escribe el c√≥digo y presiona Enter...">
                            <button type="button" onclick="toggleScanner('inv')"
                                class="bg-gray-700 hover:bg-gray-600 text-white px-4 rounded-xl transition-colors flex items-center justify-center">
                                <i class="fa-solid fa-barcode text-xl"></i>
                            </button>
                        </div>
                        <!-- Contenedor de la c√°mara -->
                        <div id="reader-inv" class="hidden w-full rounded-xl overflow-hidden border-2 border-gold mt-2">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Nombre del
                                Producto</label>
                            <input type="text" id="invNombre"
                                class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-gold">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Categor√≠a</label>
                            <input type="text" id="invCategoria"
                                class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-gold">
                        </div>
                    </div>

                    <!-- Fila de Precios con C√°lculo Autom√°tico -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-end mb-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Costo ($)</label>
                            <input type="number" id="invCosto" step="0.01" oninput="calcularPrecio('inv')"
                                class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-gold"
                                placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Ganancia %</label>
                            <input type="number" id="invGanancia" step="0.01" oninput="calcularPrecio('inv')"
                                class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-gold"
                                placeholder="30">
                        </div>
                        <div>
                            <label class="block text-xs text-gold mb-2 font-bold uppercase">Precio Final</label>
                            <input type="number" id="invPrecio" step="0.01"
                                class="w-full bg-gold/10 border border-gold rounded-lg px-4 py-3 text-white font-bold focus:outline-none"
                                placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-2 font-bold uppercase">Stock</label>
                            <input type="number" id="invStock"
                                class="w-full bg-dark/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-gold">
                        </div>
                    </div>

                    <button onclick="guardarProducto()" id="btnGuardarProducto"
                        class="w-full h-[50px] bg-gold hover:bg-amber-600 text-dark font-bold rounded-lg flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-gold/20">
                        <i class="fa-solid fa-plus"></i> Guardar Producto
                    </button>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden md:overflow-visible">
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800/50">
                        <h3 class="font-bold text-gray-300">Lista de Productos</h3>
                        <button onclick="cargarInventario()"
                            class="text-xs text-gold hover:text-white flex items-center gap-1">
                            <i class="fa-solid fa-sync"></i> Actualizar
                        </button>
                    </div>
                    <div class="md:overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <!-- ‚úÖ CAMBIO 1: AGREGADA COLUMNA COSTO -->
                            <thead
                                class="bg-dark/50 text-[10px] uppercase tracking-wider text-gray-500 border-b border-gray-700">
                                <tr>
                                    <th class="px-4 py-3 font-bold">Producto</th>
                                    <th class="px-4 py-3 font-bold">Categor√≠a</th>
                                    <th class="px-4 py-3 font-bold text-center">Costo</th> <!-- Agregado -->
                                    <th class="px-4 py-3 font-bold text-center">Precio</th>
                                    <th class="px-4 py-3 font-bold text-center">Stock</th>
                                    <th class="px-4 py-3 font-bold text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="listaInventario" class="divide-y divide-gray-800 text-sm">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500">
                                        <i class="fa-solid fa-box-open text-3xl mb-2 opacity-50 block mx-auto"></i>
                                        Cargando inventario...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CONFIGURACI√ìN SCREEN -->
            <div id="config-screen" class="screen max-w-2xl mx-auto">
                <div class="flex items-center justify-between mb-8">
                    <button onclick="showMenuScreen()"
                        class="md:hidden flex items-center text-gray-400 hover:text-white">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Men√∫
                    </button>
                    <h2 class="text-2xl font-bold text-accent flex items-center gap-2">
                        <i class="fa-solid fa-gear"></i> Configuraci√≥n
                    </h2>
                    <div></div>
                </div>

                <div class="glass-panel rounded-2xl p-6 space-y-6">
                    <!-- Cerrar Sesi√≥n -->
                    <div class="border-b border-gray-700 pb-6">
                        <h3 class="text-gold font-bold mb-4 uppercase text-sm">Sesi√≥n</h3>
                        <button onclick="cerrarSesion()"
                            class="w-full bg-red-500/10 hover:bg-red-500 border border-red-500/50 hover:border-red-500 text-red-500 hover:text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            Cerrar Sesi√≥n
                        </button>
                    </div>

                    <!-- Tema -->
                    <div class="border-b border-gray-700 pb-6">
                        <h3 class="text-gold font-bold mb-4 uppercase text-sm">Apariencia</h3>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300">Tema Oscuro</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="temaToggle" checked disabled class="sr-only peer">
                                <div
                                    class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                                </div>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Actualmente solo disponible en tema oscuro</p>
                    </div>

                    <!-- Sonidos -->
                    <div class="border-b border-gray-700 pb-6">
                        <h3 class="text-gold font-bold mb-4 uppercase text-sm">Sonidos</h3>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300">Notificaciones Sonoras</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="sonidoToggle" onchange="toggleSonido()" class="sr-only peer">
                                <div
                                    class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                                </div>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Habilitar sonidos para notificaciones de la app</p>
                    </div>

                    <!-- Informaci√≥n -->
                    <div class="border-b border-gray-700 pb-6">
                        <h3 class="text-gold font-bold mb-4 uppercase text-sm">Informaci√≥n</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="text-gray-400">Versi√≥n</div>
                                <div class="text-white font-bold">1.0.0</div>
                            </div>
                            <div>
                                <div class="text-gray-400">Usuario</div>
                                <div class="text-white font-bold" id="configUserId">---</div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="text-gray-400 text-sm">√öltima Sincronizaci√≥n</div>
                            <div class="text-white font-bold" id="ultimaSync">Nunca</div>
                        </div>
                    </div>

                    <!-- Limpiar Cach√© -->
                    <div class="pt-4">
                        <button onclick="limpiarCache()"
                            class="w-full bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-trash"></i> Limpiar Cach√© Local
                        </button>
                        <p class="text-xs text-gray-500 mt-2 text-center">Elimina todos los datos almacenados localmente
                        </p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- MOBILE BOTTOM NAV -->
    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-card/95 backdrop-blur border-t border-gray-800 z-50">
        <div class="grid grid-cols-5 h-16">
            <button onclick="showMenuScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white">
                <i class="fa-solid fa-house text-lg mb-1"></i>
                <span class="text-[10px]">Inicio</span>
            </button>
            <button onclick="showVentasScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white">
                <i class="fa-solid fa-cash-register text-lg mb-1"></i>
                <span class="text-[10px]">Ventas</span>
            </button>
            <button onclick="showGastosScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white">
                <i class="fa-solid fa-file-invoice-dollar text-lg mb-1"></i>
                <span class="text-[10px]">Gastos</span>
            </button>
            <button onclick="showHistorialScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white">
                <i class="fa-solid fa-clock-rotate-left text-lg mb-1"></i>
                <span class="text-[10px]">Historial</span>
            </button>
            <button onclick="showInventarioScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white">
                <i class="fa-solid fa-boxes-stacked text-lg mb-1"></i>
                <span class="text-[10px]">Inventario</span>
            </button>
            <button onclick="showConfigScreen()"
                class="flex flex-col items-center justify-center text-gray-400 hover:text-white">
                <i class="fa-solid fa-gear text-lg mb-1"></i>
                <span class="text-[10px]">Config</span>
            </button>
        </div>
    </nav>

    <!-- MODAL COBRO -->
    <div id="modalCobro"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-card border border-primary/50 rounded-2xl p-6 w-full max-w-sm">
            <button onclick="cerrarModalCobro()"
                class="absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button>

            <div class="text-center mb-6">
                <h3 class="text-gray-400 text-sm font-bold uppercase mb-2">Total a Pagar</h3>
                <div id="modalAmount" class="text-5xl font-mono font-bold text-white">$ 0.00</div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="procesarCobro('Efectivo')"
                    class="p-4 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-xl flex flex-col items-center gap-2">
                    <span class="text-2xl">üíµ</span>
                    <span class="text-sm font-bold">Efectivo</span>
                </button>
                <button onclick="procesarCobro('Tarjeta')"
                    class="p-4 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-xl flex flex-col items-center gap-2">
                    <span class="text-2xl">üí≥</span>
                    <span class="text-sm font-bold">Tarjeta</span>
                </button>
                <button onclick="procesarCobro('Transferencia')"
                    class="p-4 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-xl flex flex-col items-center gap-2">
                    <span class="text-2xl">üè¶</span>
                    <span class="text-sm font-bold">Transferencia</span>
                </button>
                <button onclick="procesarCobro('Fiado')"
                    class="p-4 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-xl flex flex-col items-center gap-2">
                    <span class="text-2xl">üìù</span>
                    <span class="text-sm font-bold">Fiado</span>
                </button>
            </div>

            <button onclick="cerrarModalCobro()"
                class="w-full py-3 rounded-lg text-gray-400 hover:text-white">Cancelar</button>
        </div>
    </div>

    <!-- MODAL EDITAR TRANSACCION -->
    <div id="modalEdit"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-card border border-secondary rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold text-secondary mb-6 text-center">Editar Transacci√≥n</h3>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-xs text-gray-400 mb-1 font-bold">Monto ($)</label>
                    <input type="number" id="editMonto"
                        class="w-full bg-dark border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-secondary">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1 font-bold">Descripci√≥n / Detalles</label>
                    <textarea id="editDescripcion" rows="3"
                        class="w-full bg-dark border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-secondary"></textarea>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="cerrarModalEdit()"
                    class="py-3 bg-gray-800 hover:bg-gray-700 text-white font-bold rounded-xl transition-all">
                    Cancelar
                </button>
                <button onclick="guardarEdicion()"
                    class="py-3 bg-secondary hover:bg-indigo-600 text-white font-black rounded-xl transition-all">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR PRODUCTO (ACTUALIZADO) -->
    <div id="modalEditProducto"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-card border border-gold rounded-2xl p-6 w-full max-w-sm my-8">
            <h3 class="text-xl font-bold text-gold mb-6 text-center">Editar Producto</h3>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-xs text-gray-400 mb-1 font-bold">C√≥digo (No editable)</label>
                    <input type="text" id="editInvCodigo" readonly
                        class="w-full bg-dark border border-gray-700 rounded-lg px-3 py-2 text-gray-500 cursor-not-allowed">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1 font-bold">Nombre del Producto</label>
                    <input type="text" id="editInvNombre"
                        class="w-full bg-dark border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-gold">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1 font-bold">Categor√≠a</label>
                    <input type="text" id="editInvCategoria"
                        class="w-full bg-dark border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-gold">
                </div>

                <!-- ‚úÖ CAMBIO 3: AGREGADOS INPUTS DE COSTO Y GANANCIA PARA EDITAR -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1 font-bold">Costo ($)</label>
                        <input type="number" id="editInvCosto" step="0.01" min="0" oninput="calcularPrecio('editInv')"
                            class="w-full bg-dark border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-gold">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1 font-bold">Ganancia %</label>
                        <input type="number" id="editInvGanancia" step="0.01" oninput="calcularPrecio('editInv')"
                            class="w-full bg-dark border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-gold">
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-gold mb-1 font-bold">Precio Final ($)</label>
                    <input type="number" id="editInvPrecio" step="0.01" min="0"
                        class="w-full bg-dark border border-gold rounded-lg px-3 py-2 text-white font-bold focus:outline-none focus:border-gold">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1 font-bold">Stock</label>
                    <input type="number" id="editInvStock"
                        class="w-full bg-dark border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-gold">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="cerrarModalEditProducto()"
                    class="py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white">Cancelar</button>
                <button onclick="guardarEdicionProducto()"
                    class="py-2 rounded-lg bg-gold hover:bg-amber-600 text-dark font-bold">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL SOLICITAR REPORTE -->
    <div id="modalSolicitarReporte"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-card border border-secondary/50 rounded-2xl p-6 w-full max-w-sm">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-secondary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-file-invoice text-3xl text-secondary"></i>
                </div>
                <h3 class="text-xl font-bold text-white">Solicitar Reporte</h3>
                <p class="text-sm text-gray-400">Selecciona el periodo del reporte que deseas recibir por Correo.</p>
            </div>
            <div class="grid grid-cols-1 gap-3 mb-6">
                <button onclick="enviarSolicitudReporte('hoy')"
                    class="py-4 rounded-xl bg-dark border border-gray-700 hover:border-secondary text-gray-300 font-bold transition-all text-sm flex items-center justify-between px-4 group">
                    <span>Reporte de Hoy</span>
                    <i
                        class="fa-solid fa-envelope text-xs opacity-30 group-hover:opacity-100 group-hover:text-secondary transition-all"></i>
                </button>
                <button onclick="enviarSolicitudReporte('semana')"
                    class="py-4 rounded-xl bg-dark border border-gray-700 hover:border-secondary text-gray-300 font-bold transition-all text-sm flex items-center justify-between px-4 group">
                    <span>Esta Semana</span>
                    <i
                        class="fa-solid fa-envelope text-xs opacity-30 group-hover:opacity-100 group-hover:text-secondary transition-all"></i>
                </button>
                <button onclick="enviarSolicitudReporte('mes')"
                    class="py-4 rounded-xl bg-dark border border-gray-700 hover:border-secondary text-gray-300 font-bold transition-all text-sm flex items-center justify-between px-4 group">
                    <span>Este Mes</span>
                    <i
                        class="fa-solid fa-envelope text-xs opacity-30 group-hover:opacity-100 group-hover:text-secondary transition-all"></i>
                </button>
                <button onclick="enviarSolicitudReporte('anio')"
                    class="py-4 rounded-xl bg-dark border border-gray-700 hover:border-secondary text-gray-300 font-bold transition-all text-sm flex items-center justify-between px-4 group">
                    <span>Este A√±o</span>
                    <i
                        class="fa-solid fa-envelope text-xs opacity-30 group-hover:opacity-100 group-hover:text-secondary transition-all"></i>
                </button>
            </div>
            <button onclick="cerrarModalReporte()"
                class="w-full py-3 rounded-xl bg-gray-800 hover:bg-gray-700 text-white font-bold transition-all">Cancelar</button>
        </div>
    </div>

    <!-- ‚úÖ MODAL PERFIL DE USUARIO (Alineado a la derecha) -->
    <div id="modalPerfil"
        class="fixed inset-0 bg-black/60 backdrop-blur-[2px] z-[80] hidden flex justify-end items-start pt-[80px] pr-4 md:pr-8 animate-fade-in">
        <div
            class="bg-card border border-gray-700 rounded-3xl p-6 w-full max-w-sm relative overflow-hidden shadow-2xl mr-0 md:mr-0">
            <!-- Close Button -->
            <button onclick="cerrarPerfil()"
                class="absolute top-4 right-4 text-gray-400 hover:text-white z-20 bg-black/20 hover:bg-black/40 rounded-full w-8 h-8 flex items-center justify-center transition-all">
                <i class="fa-solid fa-times"></i>
            </button>

            <!-- Header Background -->
            <div
                class="absolute top-0 left-0 w-full h-28 bg-gradient-to-br from-primary/30 via-secondary/20 to-dark z-0">
            </div>

            <!-- Avatar & Upload -->
            <div class="relative z-10 flex flex-col items-center mt-6 mb-6">
                <div class="relative group cursor-pointer" onclick="document.getElementById('fileInputPerfil').click()">
                    <div
                        class="w-28 h-28 rounded-full border-4 border-card bg-gray-800 overflow-hidden shadow-2xl relative">
                        <img id="profileImageModal" src="https://ui-avatars.com/api/?name=User&background=random"
                            class="w-full h-full object-cover">
                        <!-- Overlay de carga -->
                        <div
                            class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-[2px]">
                            <i class="fa-solid fa-camera text-white text-2xl drop-shadow-lg"></i>
                        </div>
                    </div>
                    <!-- Badge de edici√≥n -->
                    <div
                        class="absolute bottom-1 right-1 bg-primary text-white w-8 h-8 rounded-full border-4 border-card flex items-center justify-center text-xs shadow-lg">
                        <i class="fa-solid fa-pen"></i>
                    </div>
                    <!-- Hidden Input -->
                    <input type="file" id="fileInputPerfil" accept="image/*" class="hidden"
                        onchange="actualizarFotoPerfil(this)">
                </div>

                <h3 id="perfilNombre" class="text-2xl font-bold text-white mt-4 text-center">Cargando...</h3>
                <div class="flex items-center gap-2 mt-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p id="perfilId"
                        class="text-xs text-green-400 font-mono bg-green-500/10 px-3 py-1 rounded-full border border-green-500/20">
                        ID: ---</p>
                </div>
            </div>

            <!-- Personal Data -->
            <div class="space-y-3 mb-8 z-10 relative bg-dark/30 rounded-2xl p-4 border border-gray-700/50">
                <div class="flex items-center gap-3 pb-3 border-b border-gray-700/50 last:border-0 last:pb-0">
                    <div class="w-8 h-8 rounded-lg bg-gray-800 flex items-center justify-center text-gray-400">
                        <i class="fa-solid fa-store"></i>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Comercio</p>
                        <p id="perfilComercio" class="text-sm font-medium text-white">---</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 pt-2">
                    <div class="w-8 h-8 rounded-lg bg-gray-800 flex items-center justify-center text-gray-400">
                        <i class="fa-solid fa-calendar-check"></i>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Miembro desde</p>
                        <p class="text-sm font-medium text-white">Enero 2026</p>
                    </div>
                </div>
            </div>

            <!-- Logout Button (Bottom) -->
            <button onclick="cerrarSesion()"
                class="w-full bg-gradient-to-r from-red-500/10 to-red-900/10 hover:from-red-500 hover:to-red-600 text-red-500 hover:text-white border border-red-500/20 hover:border-transparent font-bold py-4 rounded-xl transition-all duration-300 flex items-center justify-center gap-3 group">
                <div
                    class="w-8 h-8 rounded-full bg-red-500/20 group-hover:bg-white/20 flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-power-off"></i>
                </div>
                <span>CERRAR SESI√ìN</span>
            </button>
            <p class="text-[10px] text-center text-gray-600 mt-4">Versi√≥n 1.0.0 ‚Ä¢ POS Antigravity</p>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="notification"
        class="fixed top-20 right-4 p-4 rounded-lg shadow-2xl transform translate-x-[150%] transition-transform duration-300 z-[100] flex items-center gap-3 min-w-[300px] border-l-4">
        <div id="notifIcon" class="text-xl"></div>
        <div id="notifMessage" class="font-bold text-sm"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
            // --- EL GUARDI√ÅN DE SEGURIDAD ---
            (function () {
                const params = new URLSearchParams(window.location.search);
                const idUrl = params.get('id'); // El ID que alguien escribi√≥ en la URL
                const idSesion = sessionStorage.getItem('sesion_activa'); // El ID que guardamos en el Login

                // Si no hay sesi√≥n, o si el ID de la URL no coincide con el del Login... ¬°AFUERA!
                if (!idSesion || idUrl !== idSesion) {
                    console.error("Acceso no autorizado o ID manipulado.");
                    window.location.href = 'index.html';
                }
            })();
        // --------------------------------
        const WEBHOOKS = {
            CONSULTA: 'https://n8n.arnaldoayalaestratega.com/webhook/comerciante',
            REGISTRO: 'https://n8n.arnaldoayalaestratega.com/webhook/registro-comerciante',
            GUARDAR: 'https://n8n.arnaldoayalaestratega.com/webhook/pos-guardar-venta',
            GUARDAR_BATCH: 'https://n8n.arnaldoayalaestratega.com/webhook/guardar-local',
            HISTORIAL: 'https://n8n.arnaldoayalaestratega.com/webhook/historial',
            EDITAR: 'https://n8n.arnaldoayalaestratega.com/webhook/transaccion-actualizar',
            ELIMINAR: 'https://n8n.arnaldoayalaestratega.com/webhook/transaccion-eliminar',
            INVENTARIO: 'https://n8n.arnaldoayalaestratega.com/webhook/inventario',
            CONSULTA_INVENTARIO: 'https://n8n.arnaldoayalaestratega.com/webhook/consulta-inventario',
            INVENTARIO_ACTUALIZAR: 'https://n8n.arnaldoayalaestratega.com/webhook/inventario-actualizar',
            INVENTARIO_ELIMINAR: 'https://n8n.arnaldoayalaestratega.com/webhook/inventario-eliminar',
            // ‚úÖ AGREGADO WEBHOOK DE REPORTE POR EMAIL
            REPORTE_EMAIL: 'https://n8n.arnaldoayalaestratega.com/webhook/generar-reporte'
        };

        let comercianteData = { id: '', nombre: '' };
        let ventaActual = { items: [], total: 0 };
        let contadorProductos = 1;
        let transaccionesData = [];
        let filtroActual = 'mes'; // ‚úÖ CAMBIO A MES POR DEFECTO PARA VER DATOS SIEMPRE
        let transaccionEditando = null;
        let inventario = [];
        let isOnline = navigator.onLine;
        let selectedResultIndex = -1;

        // ‚úÖ Sistema de Queue Offline
        const STORAGE_KEYS = {
            QUEUE_PENDIENTES: 'transacciones_pendientes',
            INVENTARIO_CACHE: 'inventario_cache',
            LAST_INVENTARIO_SYNC: 'last_inventario_sync'
        };

        function guardarEnQueue(transaccion) {
            const queue = JSON.parse(localStorage.getItem(STORAGE_KEYS.QUEUE_PENDIENTES) || '[]');
            queue.push(transaccion);
            localStorage.setItem(STORAGE_KEYS.QUEUE_PENDIENTES, JSON.stringify(queue));
            console.log('üì¥ Transacci√≥n guardada offline:', transaccion);
        }

        function obtenerQueue() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.QUEUE_PENDIENTES) || '[]');
        }

        function limpiarQueue() {
            localStorage.removeItem(STORAGE_KEYS.QUEUE_PENDIENTES);
            console.log('üóëÔ∏è Queue limpiada');
        }

        // ‚úÖ Funciones de cach√© de inventario
        function guardarInventarioCache(data) {
            if (!comercianteData.id) return;
            const cacheData = {
                comercio_id: comercianteData.id,
                timestamp: Date.now(),
                productos: data
            };
            localStorage.setItem(STORAGE_KEYS.INVENTARIO_CACHE, JSON.stringify(cacheData));
        }

        function obtenerInventarioCache() {
            const cache = localStorage.getItem(STORAGE_KEYS.INVENTARIO_CACHE);
            if (!cache) return [];
            try {
                const parsed = JSON.parse(cache);
                // Solo devolver si el cache pertenece al comerciante actual
                if (parsed.comercio_id !== comercianteData.id) return [];
                return parsed.productos || [];
            } catch (e) { return []; }
        }

        function inventarioCacheValido() {
            const cache = localStorage.getItem(STORAGE_KEYS.INVENTARIO_CACHE);
            if (!cache) return false;
            try {
                const parsed = JSON.parse(cache);
                // Validar que sea del mismo comerciante y que no tenga m√°s de 30 min
                const esMismoComercio = parsed.comercio_id === comercianteData.id;
                const esReciente = (Date.now() - parsed.timestamp) < (30 * 60 * 1000);
                return esMismoComercio && esReciente;
            } catch (e) { return false; }
        }

        async function sincronizarQueue() {
            const queue = obtenerQueue();
            if (queue.length === 0) {
                console.log('‚úÖ No hay transacciones pendientes');
                return;
            }

            console.log('üîÑ Sincronizando', queue.length, 'transacciones pendientes...');
            mostrarNotificacion(`üîÑ Sincronizando ${queue.length} transacciones...`, 'warning');

            try {
                // ‚úÖ Enviar TODAS las transacciones juntas al webhook batch
                const response = await fetch(WEBHOOKS.GUARDAR_BATCH, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_comerciante: comercianteData.id,
                        transacciones: queue  // ‚úÖ Array completo
                    })
                });

                if (response.ok) {
                    limpiarQueue();
                    mostrarNotificacion(`‚úÖ ${queue.length} transacciones sincronizadas`, 'success');
                    console.log('‚úÖ Sincronizaci√≥n exitosa');
                } else {
                    throw new Error('Error en respuesta del servidor');
                }
            } catch (error) {
                console.error('‚ùå Error sincronizando:', error);
                mostrarNotificacion('‚ùå Error al sincronizar. Se reintentar√° m√°s tarde.', 'error');
            }
        }

        // ‚úÖ Detectar cambios de conexi√≥n
        window.addEventListener('online', async () => {
            isOnline = true;
            console.log('üü¢ Conexi√≥n restaurada');

            // ‚úÖ Actualizar indicador visual
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500"></div><span class="text-xs text-green-500">Online</span>';
            }

            mostrarNotificacion('üü¢ Conexi√≥n restaurada', 'success');
            await sincronizarQueue();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            console.log('üî¥ Sin conexi√≥n - Modo offline activado');

            // ‚úÖ Actualizar indicador visual
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500"></div><span class="text-xs text-red-500">Offline</span>';
            }

            mostrarNotificacion('üì¥ Modo offline activado', 'warning');
        });

        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            if (!id) {
                mostrarNotificacion('‚ùå Error: ID ausente en la URL', 'error');
                return;
            }

            await cargarComercianteData(id);
            cargarVentaGuardada();

            // ‚úÖ CARGA INICIAL ROBUSTA: PRIMERO CACH√â, LUEGO RED
            await cargarInventario(false);

            // ‚úÖ Sincronizar transacciones pendientes si hay internet
            if (isOnline) {
                const queue = obtenerQueue();
                if (queue.length > 0) {
                    console.log('üîÑ Transacciones pendientes detectadas:', queue.length);
                    await sincronizarQueue();
                }
            }
        });

        async function cargarComercianteData(id) {
            // ‚úÖ FIX: Asignar ID inmediatamente para que est√© disponible aunque falle la consulta del nombre
            comercianteData.id = id;
            updateUIFields('userId', id);
            updateUIFields('sidebarUserId', id);
            updateUIFields('headerUserId', id);

            try {
                const response = await fetch(`${WEBHOOKS.CONSULTA}?id=${id}`);
                const data = await response.json();

                if (data.error) {
                    // Si hay error, ya tenemos el ID, solo notificamos
                    mostrarNotificacion(`‚ö†Ô∏è ${data.message || 'Error cargando nombre'}`, 'warning');
                    return;
                }

                comercianteData.nombre = data.nombre || data.Nombre_Local || 'Comerciante';

                updateUIFields('userName', comercianteData.nombre);
                updateUIFields('sidebarUserName', comercianteData.nombre);
                updateUIFields('headerUserName', comercianteData.nombre); // Might not exist on mobile now, handled safely

                // ‚úÖ Update Avatars
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(comercianteData.nombre)}&background=random`;
                const mobileImg = document.getElementById('mobileHeaderProfileImg');
                const desktopImg = document.getElementById('profileImageBtn');

                if (mobileImg) mobileImg.src = avatarUrl;
                if (desktopImg) desktopImg.src = avatarUrl;

                const miniPerfil = document.getElementById('miniPerfilNombre');
                if (miniPerfil) miniPerfil.textContent = comercianteData.nombre;

            } catch (error) {
                console.error('Error:', error);
                // No bloqueamos, el ID ya est√° seteado
                mostrarNotificacion('‚ö†Ô∏è Usando modo sin conexi√≥n (Nombre no cargado)', 'warning');
            }
        }

        function updateUIFields(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        function showMenuScreen() {
            hideAllScreens();
            document.getElementById('menu-screen').classList.add('active');
            // Mostrar bot√≥n perfil
            // Mostrar bot√≥n perfil (Desktop) - Usamos style para respetar clases responsivas (hidden md:block)
            const perfilBtn = document.getElementById('perfil-btn-container');
            if (perfilBtn) perfilBtn.style.display = ''; // Revert to CSS (hidden on mobile, block on desktop)

            if (window.toggleBot) window.toggleBot(true);
        }
        async function showVentasScreen() {
            hideAllScreens();
            document.getElementById('ventas-screen').classList.add('active');
            if (window.toggleBot) window.toggleBot(false);

            // ‚úÖ Asegurar inventario fresco si est√° vac√≠o, pero sin bloquear la UI
            if (inventario.length === 0) {
                console.log('üì¶ Inventario vac√≠o al abrir ventas, intentando cargar...');
                await cargarInventario(false); // False = intenta cach√© primero
            }

            document.getElementById('descripcionInput').focus();
        }
        function showGastosScreen() { hideAllScreens(); document.getElementById('gastos-screen').classList.add('active'); if (window.toggleBot) window.toggleBot(false); document.getElementById('montoGasto').focus(); }
        function showInventarioScreen() { hideAllScreens(); document.getElementById('inventario-screen').classList.add('active'); if (window.toggleBot) window.toggleBot(false); }
        async function showHistorialScreen() { hideAllScreens(); document.getElementById('historial-screen').classList.add('active'); if (window.toggleBot) window.toggleBot(false); await cargarHistorial(); }
        function showConfigScreen() {
            hideAllScreens();
            document.getElementById('config-screen').classList.add('active');
            if (window.toggleBot) window.toggleBot(false);
            // Actualizar info del usuario en config
            const configUserId = document.getElementById('configUserId');
            if (configUserId) configUserId.textContent = comercianteData.id || '---';
            // Cargar estado del toggle de sonido
            const sonidoToggle = document.getElementById('sonidoToggle');
            if (sonidoToggle) sonidoToggle.checked = localStorage.getItem('sonidosEnabled') === 'true';
        }
        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            // Ocultar bot√≥n perfil en otras pantallas para limpiar UI
            // Ocultar bot√≥n perfil en otras pantallas
            const perfilBtn = document.getElementById('perfil-btn-container');
            if (perfilBtn) perfilBtn.style.display = 'none'; // Force hide
        }

        // ==========================================
        //  NUEVA L√ìGICA DE ESC√ÅNER Y PRECIOS
        // ==========================================

        let html5QrcodeScanner = null;

        function toggleScanner(prefix) {
            // 'prefix' puede ser 'inv' (crear) o 'ventas' (vender)
            const readerId = `reader-${prefix}`;
            const readerDiv = document.getElementById(readerId);

            // Si ya est√° abierto, lo cerramos
            if (!readerDiv.classList.contains('hidden')) {
                cerrarScanner(prefix);
                return;
            }

            // Abrimos el esc√°ner
            readerDiv.classList.remove('hidden');

            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5Qrcode(readerId);
            }

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            // Preferimos la c√°mara trasera ('environment')
            html5QrcodeScanner.start({ facingMode: "environment" }, config, (decodedText) => {
                onScanSuccess(decodedText, prefix);
            })
                .catch(err => {
                    console.error("Error al iniciar c√°mara", err);
                    alert("No se pudo iniciar la c√°mara. Aseg√∫rate de dar permisos.");
                });
        }

        // ‚úÖ FUNCI√ìN DE B√öSQUEDA ROBUSTA (Reemplazar la anterior)
        function verificarExistencia(codigoRaw) {
            if (!codigoRaw) return;

            // 1. Convertimos lo escaneado a Texto Puro, May√∫sculas y sin espacios
            const codigoBuscado = String(codigoRaw).trim().toUpperCase();

            console.log("--------------------------------");
            console.log("üîç Escaneado:", codigoBuscado);

            // Debug: Ver si el inventario tiene datos cargados
            if (!inventario || inventario.length === 0) {
                console.warn("‚ö†Ô∏è El inventario en memoria est√° vac√≠o. Revisa la carga inicial.");
                mostrarNotificacion('‚ö†Ô∏è Inventario vac√≠o o cargando...', 'warning');
                return;
            }

            // 2. B√∫squeda profunda comparando Texto contra Texto
            const productoExistente = inventario.find(p => {
                // Armamos una lista de todos los posibles c√≥digos que tenga ese producto
                const codigosProducto = [
                    p.id,
                    p.codigo,
                    p.codigo_barra,
                    p.Codigo,       // Por si viene con may√∫scula de la base de datos
                    p.barcode       // Por si acaso
                ];

                // Verificamos si alguno coincide
                return codigosProducto.some(valor => {
                    if (valor === null || valor === undefined) return false;
                    return String(valor).trim().toUpperCase() === codigoBuscado;
                });
            });

            if (productoExistente) {
                console.log("‚úÖ ENCONTRADO:", productoExistente.nombre);
                mostrarNotificacion(`üì¶ Encontrado: ${productoExistente.nombre}`, 'success');

                // Limpiamos campo y quitamos foco para evitar doble lectura
                const inputCodigo = document.getElementById('invCodigo');
                if (inputCodigo) {
                    inputCodigo.value = '';
                    inputCodigo.blur();
                }

                // Abrimos el modal de edici√≥n
                // Usamos el ID real para asegurar que la edici√≥n funcione
                editarProducto(productoExistente.id, codigoBuscado);

            } else {
                console.log("‚ùå NO ENCONTRADO en una lista de " + inventario.length + " productos.");
                // Si no existe, avisamos visualmente y pasamos al nombre
                mostrarNotificacion('‚ú® Producto Nuevo', 'warning');
                document.getElementById('invNombre').focus();
            }
        }

        function onScanSuccess(decodedText, prefix) {
            // 1. Efecto visual y feedback inmediato
            // Para inventario usamos 'invCodigo', para ventas 'descripcionInput'
            const inputId = prefix === 'inv' ? 'invCodigo' : 'descripcionInput';
            const inputCodigo = document.getElementById(inputId);

            if (inputCodigo) {
                inputCodigo.value = decodedText;
                inputCodigo.classList.add('bg-green-500/20', 'border-green-500');
                setTimeout(() => {
                    inputCodigo.classList.remove('bg-green-500/20', 'border-green-500');
                }, 1000);
            }

            // Cerrar el esc√°ner autom√°ticamente tras leer
            cerrarScanner(prefix);

            // 2. L√ìGICA INTELIGENTE SEG√öN LA PANTALLA
            if (prefix === 'inv') {
                verificarExistencia(decodedText);
            } else if (prefix === 'ventas') {
                // Si estamos en ventas, intentamos agregar el producto directo
                handleVentasEnter(decodedText);
            }
        }

        function cerrarScanner(prefix) {
            const readerDiv = document.getElementById(`reader-${prefix}`);
            if (readerDiv) readerDiv.classList.add('hidden');

            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    console.log("Esc√°ner detenido");
                    html5QrcodeScanner.clear(); // Limpia el elemento
                    html5QrcodeScanner = null;  // Resetea la instancia para poder reabrir
                }).catch(err => console.error(err));
            }
        }

        function calcularPrecio(prefix) {
            const costo = parseFloat(document.getElementById(`${prefix}Costo`).value) || 0;
            const ganancia = parseFloat(document.getElementById(`${prefix}Ganancia`).value) || 0;

            if (costo > 0) {
                const precioFinal = costo * (1 + (ganancia / 100));
                document.getElementById(`${prefix}Precio`).value = precioFinal.toFixed(2);
            }
        }


        // ==========================================
        //  FIN L√ìGICA DE ESC√ÅNER Y PRECIOS
        // ==========================================

        async function cargarInventario(force = false) {
            if (!comercianteData.id) return;

            const listEl = document.getElementById('listaInventario');

            // ‚úÖ ESTRATEGIA LOCAL-FIRST (PRIMERO LOCAL)
            // 1. Intentar cargar del cach√© local INMEDIATAMENTE
            const cache = obtenerInventarioCache();
            if (cache.length > 0) {
                console.log('‚ö° Carga r√°pida desde cach√© local:', cache.length, 'productos');
                inventario = cache; // Cargamos en RAM
                renderInventarioList(); // Mostramos en pantalla
                if (!force && isOnline) {
                    mostrarNotificacion('üì¶ Inventario cargado (Local)', 'success');
                }
            } else {
                if (!isOnline) {
                    listEl.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa-solid fa-triangle-exclamation text-3xl mb-2"></i><p>Sin conexi√≥n y sin cach√© local.</p></div>';
                    return;
                }
            }

            // 2. Si forzamos la recarga O no tenemos cach√©, vamos a la red
            // O si tenemos red, actualizamos en segundo plano silenciosamente
            if (force || (isOnline && cache.length === 0)) {
                if (force) {
                    listEl.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fa-solid fa-spinner fa-spin text-3xl mb-2"></i><p>Actualizando lista...</p></div>';
                    localStorage.removeItem(STORAGE_KEYS.INVENTARIO_CACHE);
                }

                try {
                    console.log('üåê Conectando con servidor para actualizar inventario...');
                    const response = await fetch(`${WEBHOOKS.CONSULTA_INVENTARIO}?id_comerciante=${comercianteData.id}`);
                    const data = await response.json();

                    inventario = Array.isArray(data) ? data : (data.productos || []);

                    // ‚úÖ Actualizamos el cach√© con lo nuevo
                    console.log('‚úÖ Inventario actualizado desde servidor:', inventario.length);
                    guardarInventarioCache(inventario);

                    renderInventarioList();
                    if (force) mostrarNotificacion('‚úÖ Inventario actualizado', 'success');

                } catch (e) {
                    console.error('‚ùå Error loading inventory from network:', e);
                    if (force) {
                        // Si fall√≥ la carga forzada y no hab√≠a cach√©...
                        listEl.innerHTML = '<div class="text-center py-8 text-red-400"><i class="fa-solid fa-triangle-exclamation text-2xl mb-2"></i><p>Error de conexi√≥n</p></div>';
                    }
                }
            } else if (isOnline && cache.length > 0) {
                // 3. ACTUALIZACI√ìN SILENCIOSA EN BACKGROUND
                // Ya mostramos el cach√©, pero vamos a pedir datos nuevos por si acaso cambiaron precios
                console.log('üîÑ Actualizando inventario en segundo plano...');
                fetch(`${WEBHOOKS.CONSULTA_INVENTARIO}?id_comerciante=${comercianteData.id}`)
                    .then(r => r.json())
                    .then(data => {
                        const nuevosDatos = Array.isArray(data) ? data : (data.productos || []);
                        if (JSON.stringify(nuevosDatos) !== JSON.stringify(cache)) {
                            console.log('‚ú® Detectados cambios en el inventario, actualizando...');
                            inventario = nuevosDatos;
                            guardarInventarioCache(inventario);
                            renderInventarioList(); // Refrescamos la lista si estamos en esa pantalla
                        } else {
                            console.log('üëç Inventario local ya estaba actualizado.');
                        }
                    })
                    .catch(err => console.log('‚ö†Ô∏è No se pudo actualizar en background (no es cr√≠tico)', err));
            }
        }

        async function guardarProducto() {
            const nombre = document.getElementById('invNombre').value.trim();
            const precio = parseFloat(document.getElementById('invPrecio').value);
            const stock = parseInt(document.getElementById('invStock').value) || 0;
            const categoria = document.getElementById('invCategoria').value.trim();

            // Nuevos Campos
            const codigo = document.getElementById('invCodigo').value.trim();
            const costo = parseFloat(document.getElementById('invCosto').value) || 0;
            const ganancia = parseFloat(document.getElementById('invGanancia').value) || 0;

            // ‚úÖ CORRECCI√ìN: Ahora permitimos que el precio sea 0 (importante para comercios)
            if (!nombre || isNaN(precio)) {
                mostrarNotificacion('‚ö†Ô∏è Nombre y Precio requeridos', 'error');
                return;
            }

            const btn = document.getElementById('btnGuardarProducto');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';
            btn.disabled = true;

            const payload = {
                id_comerciante: comercianteData.id,
                nombre: nombre,
                precio_final: precio, // ‚úÖ Aseg√∫rate que en n8n el campo se llame exactamente as√≠
                stock: stock,
                categoria: categoria,
                codigo: codigo,
                codigo_barra: codigo,
                precio_costo: costo,
                ganancia_porcentaje: ganancia
            };

            if (!isOnline) {
                const nuevoProducto = {
                    id: `temp_${Date.now()}`,
                    nombre: nombre,
                    precio_final: precio,
                    stock: stock,
                    categoria: categoria,
                    codigo: codigo || 'PENDIENTE',
                    codigo_barra: codigo, // ‚úÖ COMMA CORREGIDA AQU√ç
                    precio_costo: costo,
                    ganancia_porcentaje: ganancia
                };

                inventario.push(nuevoProducto);
                guardarInventarioCache(inventario);
                renderInventarioList();
                mostrarNotificacion('üì¥ Producto guardado offline', 'warning');
                limpiarCamposInventario();
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            try {
                const response = await fetch(WEBHOOKS.INVENTARIO, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Error en el servidor');

                mostrarNotificacion('‚úÖ Producto guardado', 'success');
                limpiarCamposInventario();
                await cargarInventario(true);
            } catch (e) {
                console.error('‚ùå Error saving product:', e);
                mostrarNotificacion('‚ùå Error al guardar. Se guardar√° offline.', 'error');
                guardarEnQueue({ ...payload, type: 'INVENTARIO' });
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function limpiarCamposInventario() {
            document.getElementById('invNombre').value = '';
            document.getElementById('invPrecio').value = '';
            document.getElementById('invStock').value = '';
            document.getElementById('invCategoria').value = '';
            document.getElementById('invCodigo').value = '';
            document.getElementById('invCosto').value = '';
            document.getElementById('invGanancia').value = '';
            // Cerrar scanner si qued√≥ abierto
            cerrarScanner('inv');
        }

        function renderInventarioList() {
            const listEl = document.getElementById('listaInventario');
            if (inventario.length === 0) {
                listEl.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500"><i class="fa-solid fa-box-open text-3xl mb-2 block"></i>Inventario Vac√≠o en la base de datos</td></tr>';
                return;
            }
            listEl.innerHTML = inventario.map(p => {
                // Probamos todas las combinaciones posibles que n8n/supabase podr√≠an devolver
                const stock = (p.stock != null) ? p.stock : (p.stock_actual != null ? p.stock_actual : 0);
                const categoria = p.categoria || p.Categoria || p.category || '-';

                // Manejo de precio: usamos precio_final si existe, sino precio
                const precioMostrar = p.precio_final || p.precio || 0;

                // ‚úÖ CAMBIO 2: LEER Y MOSTRAR COSTO
                const costoMostrar = p.precio_costo || 0;

                // Manejo de c√≥digo: puede venir como codigo o codigo_barra
                const codigoMostrar = p.codigo_barra || p.codigo || 'SIN CODIGO';

                return `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-4 py-3" data-label="Producto">
                        <div class="font-bold text-white">${p.nombre}</div>
                        <div class="text-[10px] text-gray-400 font-mono flex items-center gap-1">
                            <i class="fa-solid fa-barcode"></i> ${codigoMostrar}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-gray-400 text-xs" data-label="Categor√≠a">${categoria}</td>
                    
                    <!-- ‚úÖ COLUMNA COSTO EN LA TABLA -->
                    <td class="px-4 py-3 font-mono text-gray-400 text-center" data-label="Costo">$ ${parseFloat(costoMostrar).toFixed(2)}</td>

                    <td class="px-4 py-3 font-mono font-bold text-white text-center" data-label="Precio">$ ${parseFloat(precioMostrar).toFixed(2)}</td>
                    <td class="px-4 py-3 font-bold text-center ${stock <= 5 ? 'text-red-400' : 'text-primary'}" data-label="Stock">
                        ${stock}
                    </td>
                    <td class="px-4 py-3 text-right">
                        <div class="flex gap-2 justify-end">
                            <button onclick="editarProducto('${p.id}', '${codigoMostrar}')" 
                                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gold/10 text-gold border border-gold/20 hover:bg-gold hover:text-dark text-xs font-bold uppercase transition-all">
                                <i class="fa-solid fa-pen"></i> Editar
                            </button>
                            <button onclick="eliminarProducto('${p.id}', '${codigoMostrar}')" 
                                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500 hover:text-white text-xs font-bold uppercase transition-all">
                                <i class="fa-solid fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // ‚úÖ Buscar productos (funciona offline con cach√©)
        function buscarProductos(query) {
            const resultsEl = document.getElementById('productosResultados');
            const btnClear = document.getElementById('btnClearSearch');
            selectedResultIndex = -1; // Reset selection

            if (!query) {
                resultsEl.classList.add('hidden');
                btnClear.classList.add('hidden');
                return;
            }

            btnClear.classList.remove('hidden');

            // ‚úÖ Buscar en el inventario (ya sea de cach√© o actualizado)
            const filtered = inventario.filter(p => {
                const q = String(query).toLowerCase().trim();
                const nombre = (p.nombre || '').toLowerCase();

                // ‚úÖ BUSQUEDA ROBUSTA: Agregamos todos los posibles campos de c√≥digo
                // Esto asegura que encuentre por codigo, codigo_barra, barcode, id, etc.
                const codigos = [
                    p.codigo,
                    p.codigo_barra,
                    p.Codigo,
                    p.barcode,
                    p.id
                ].map(c => String(c || '').toLowerCase());

                // Chequeamos si el nombre incluye la query O si alguno de los c√≥digos la incluye
                return nombre.includes(q) || codigos.some(c => c.includes(q));
            });

            if (filtered.length === 0) {
                resultsEl.innerHTML = '<div class="p-3 text-gray-500 text-sm text-center">No encontrado. <br><span class="text-xs">Presiona Enter para usar texto libre.</span></div>';
            } else {
                resultsEl.innerHTML = filtered.map((p, index) => {
                    const precio = p.precio_final || p.precio || 0;
                    const cod = p.codigo_barra || p.codigo || '';
                    return `
                    <div onclick="seleccionarProducto('${p.nombre}', ${precio})" 
                         class="search-result-item p-3 hover:bg-gray-700 cursor-pointer border-b border-gray-700/50 last:border-0"
                         data-index="${index}"
                         data-nombre="${p.nombre}"
                         data-precio="${precio}">
                        <div class="font-bold text-white text-sm">${p.nombre}</div>
                        <div class="flex justify-between text-xs text-gray-400">
                            <span>${cod}</span>
                            <span class="text-primary font-mono">$ ${parseFloat(precio).toFixed(2)}</span>
                        </div>
                    </div>
                `}).join('');
            }
            resultsEl.classList.remove('hidden');
        }

        function highlightResult(index) {
            const items = document.querySelectorAll('.search-result-item');
            items.forEach(item => item.classList.remove('selected'));

            if (index >= 0 && index < items.length) {
                const selectedItem = items[index];
                selectedItem.classList.add('selected');
                selectedItem.scrollIntoView({ block: 'nearest' });
            }
        }

        function seleccionarProducto(nombre, precio) {
            document.getElementById('descripcionInput').value = nombre;
            const montoIn = document.getElementById('montoInput');
            if (montoIn.value === '' || parseFloat(montoIn.value) === 0) {
                montoIn.value = precio;
            }
            // Resetear cantidad a 1
            document.getElementById('cantidadInput').value = 1;
            actualizarTotalItem();
            limpiarBuscador();
            document.getElementById('cantidadInput').focus();
        }

        function limpiarBuscador() {
            document.getElementById('productosResultados').classList.add('hidden');
            document.getElementById('btnClearSearch').classList.add('hidden');
        }

        // ‚úÖ NUEVA L√ìGICA: Procesar ENTER en el buscador de Ventas
        function handleVentasEnter(query) {
            if (!query) return;

            // 1. Buscamos coincidencia EXACTA por c√≥digo de barra (m√°s eficiente para scanner)
            const codigoBuscado = String(query).trim().toUpperCase();

            // ‚úÖ B√∫squeda 100% LOCAL en la variable 'inventario' (que ya est√° cargada desde cach√© o red)
            const productoEncontrado = inventario.find(p => {
                const codigosProducto = [p.id, p.codigo, p.codigo_barra, p.Codigo, p.barcode];
                // ‚úÖ Forzamos String() en cada valor para asegurar coincidencia aunque sea n√∫mero
                return codigosProducto.some(valor => String(valor).trim().toUpperCase() === codigoBuscado);
            });

            if (productoEncontrado) {
                // ‚úÖ ENCONTRADO POR C√ìDIGO: Agregar directo al carrito
                const precio = parseFloat(productoEncontrado.precio_final || productoEncontrado.precio || 0);
                const nombre = productoEncontrado.nombre;

                // Agregar item
                ventaActual.items.push({ monto: precio, descripcion: nombre });
                ventaActual.total += precio;

                // Actualizar UI
                actualizarDisplayTotal();
                actualizarListaItems();
                guardarVentaTemporal();

                // Feedback
                mostrarNotificacion(`üõí Agregado: ${nombre}`, 'success');

                // Limpiar y RE-ENFOCAR buscador (para seguir escaneando)
                const inputDesc = document.getElementById('descripcionInput');
                const inputMonto = document.getElementById('montoInput');
                inputDesc.value = '';
                inputMonto.value = '';
                inputDesc.focus();
                limpiarBuscador();

            } else {
                // ‚ùå NO ENCONTRADO POR C√ìDIGO EXACTO: ¬øEs un nombre exacto o muy parecido?
                // El usuario pidi√≥ que busque "por nombre" al dar Enter tambi√©n.
                // Intentamos buscar coincidencia exacta o usar el primer resultado de la b√∫squeda en vivo.

                // Opci√≥n A: Buscar coincidencia exacta de nombre (case insensitive)
                const productoPorNombre = inventario.find(p => p.nombre.toUpperCase() === codigoBuscado);

                if (productoPorNombre) {
                    const precio = parseFloat(productoPorNombre.precio_final || productoPorNombre.precio || 0);
                    const nombre = productoPorNombre.nombre;

                    ventaActual.items.push({ monto: precio, descripcion: nombre });
                    ventaActual.total += precio;
                    actualizarDisplayTotal();
                    actualizarListaItems();
                    guardarVentaTemporal();

                    mostrarNotificacion(`üõí Agregado: ${nombre}`, 'success');

                    const inputDesc = document.getElementById('descripcionInput');
                    const inputMonto = document.getElementById('montoInput');
                    inputDesc.value = '';
                    inputMonto.value = '';
                    inputDesc.focus();
                    limpiarBuscador();
                    return;
                }

                // Opci√≥n B: Si no es c√≥digo ni nombre exacto...
                // Si hay resultados visibles en la lista (filtrados previamente), ¬øseleccionamos el primero?
                // Esto podr√≠a ser peligroso si el filtro es muy amplio (ej: "A").
                // Mejor comportamiento: Enfocar monto para carga manual si no se encuentra nada claro.

                const inputMonto = document.getElementById('montoInput');
                const items = document.querySelectorAll('.search-result-item');

                if (selectedResultIndex >= 0 && items[selectedResultIndex]) {
                    // Si el usuario seleccion√≥ con flechas
                    const item = items[selectedResultIndex];
                    seleccionarProducto(item.dataset.nombre, item.dataset.precio);
                } else {
                    // No hay resultados claros, quiz√°s es un precio directo o producto nuevo no registrado
                    mostrarNotificacion('‚ö†Ô∏è Producto no encontrado. Ingresa monto manual.', 'warning');
                    inputMonto.focus();
                }
            }
        }

        // ‚úÖ Nueva funci√≥n para calcular total del item en tiempo real
        function actualizarTotalItem() {
            const cantidad = parseInt(document.getElementById('cantidadInput').value) || 1;
            const precioUnitario = parseFloat(document.getElementById('montoInput').value) || 0;
            const total = cantidad * precioUnitario;
            document.getElementById('totalItemDisplay').textContent = `$ ${total.toFixed(2)}`;
        }

        function agregarItem() {
            const inputMonto = document.getElementById('montoInput');
            const inputDesc = document.getElementById('descripcionInput');
            const inputCantidad = document.getElementById('cantidadInput');

            const precioUnitario = parseFloat(inputMonto.value);
            const cantidad = parseInt(inputCantidad.value) || 1;
            const montoTotal = precioUnitario * cantidad;

            if (!precioUnitario || precioUnitario <= 0) {
                mostrarNotificacion('‚ö†Ô∏è Ingresa precio v√°lido', 'error');
                return;
            }

            const descripcion = inputDesc.value.trim() || `Item ${contadorProductos}`;

            // ‚úÖ Guardamos cantidad en el item
            ventaActual.items.push({
                monto: montoTotal,
                precio_unitario: precioUnitario,
                cantidad: cantidad,
                descripcion: descripcion
            });
            contadorProductos++;

            ventaActual.total += montoTotal;

            actualizarDisplayTotal();
            actualizarListaItems();
            guardarVentaTemporal();

            // Limpiar campos
            inputMonto.value = '';
            inputDesc.value = '';
            inputCantidad.value = 1;
            actualizarTotalItem();

            // ‚úÖ VOLVER EL FOCO AL BUSCADOR
            inputDesc.focus();
            limpiarBuscador();
        }

        function actualizarDisplayTotal() {
            const totalF = ventaActual.total.toFixed(2);
            document.getElementById('totalDisplay').textContent = `$ ${totalF}`;
            document.getElementById('subtotalDisplay').textContent = `$ ${totalF}`;

            const mobTotal = document.getElementById('totalMobDisplay');
            if (mobTotal) mobTotal.textContent = `$ ${totalF}`;

            const btn = document.getElementById('btnCobrar');
            const btnMob = document.getElementById('btnCobrarMob');

            const disabled = ventaActual.items.length === 0;
            if (btn) btn.disabled = disabled;
            if (btnMob) btnMob.disabled = disabled;
        }

        function actualizarListaItems() {
            const list = document.getElementById('itemsList');

            if (ventaActual.items.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fa-solid fa-basket-shopping text-4xl mb-3 opacity-20 block mx-auto"></i>
                        <p class="text-sm">Carrito vac√≠o</p>
                    </div>`;
                return;
            }

            list.innerHTML = ventaActual.items.map((item, idx) => {
                const cantidad = item.cantidad || 1;
                const precioUnit = item.precio_unitario || item.monto;
                const cantidadLabel = cantidad > 1 ? `<span class="text-xs text-secondary">x${cantidad}</span>` : '';

                return `
                <div class="flex justify-between items-center p-3 bg-dark/40 rounded-xl border border-gray-700 group hover:border-primary/30 transition-all">
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-medium text-gray-200 truncate pr-2 flex items-center gap-2">
                            <span class="truncate block">${item.descripcion}</span> ${cantidadLabel}
                        </div>
                        <div class="text-lg font-bold text-primary font-mono">$ ${item.monto.toFixed(2)}</div>
                        ${cantidad > 1 ? `<div class="text-[10px] text-gray-500">$${precioUnit.toFixed(2)} c/u</div>` : ''}
                    </div>
                    <button onclick="eliminarItem(${idx})" class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500 hover:text-white transition-all">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            `}).reverse().join(''); // Mostrar m√°s recientes arriba
        }

        function eliminarItem(idx) {
            ventaActual.total -= ventaActual.items[idx].monto;
            ventaActual.items.splice(idx, 1);
            actualizarDisplayTotal();
            actualizarListaItems();
            guardarVentaTemporal();
        }

        function cancelarVenta() {
            if (ventaActual.items.length > 0 && !confirm('¬øCancelar venta actual?')) return;
            ventaActual = { items: [], total: 0 };
            contadorProductos = 1;
            actualizarDisplayTotal();
            actualizarListaItems();
            limpiarVentaTemporal();
            showMenuScreen();
        }

        function mostrarModalCobro() {
            document.getElementById('modalAmount').textContent = `$ ${ventaActual.total.toFixed(2)}`;
            document.getElementById('modalCobro').classList.remove('hidden');
            document.getElementById('modalCobro').classList.add('flex');
        }

        function cerrarModalCobro() {
            document.getElementById('modalCobro').classList.add('hidden');
            document.getElementById('modalCobro').classList.remove('flex');
        }

        async function procesarCobro(metodoPago) {
            cerrarModalCobro();
            const btn = document.getElementById('btnCobrar');
            const btnMob = document.getElementById('btnCobrarMob');

            if (btn) btn.disabled = true;
            if (btnMob) btnMob.disabled = true;

            const ahora = new Date();
            const fechaHoraLocal = new Date(ahora.getTime() - (ahora.getTimezoneOffset() * 60000))
                .toISOString()
                .replace('Z', '-03:00');
            const idLocal = `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            // ‚úÖ PREPARAR ITEMS PARA ENVIAR (INCLUYENDO COSTO)
            // Necesitamos buscar el costo original del producto en el inventario si existe
            const itemsConCosto = ventaActual.items.map(item => {
                // Buscamos si este item tiene un producto asociado en el inventario por nombre
                // Nota: Esto es una aproximaci√≥n, idealmente guardar√≠amos el ID del producto al agregar
                const producto = inventario.find(p => p.nombre === item.descripcion);
                const costoUnitario = producto ? (parseFloat(producto.precio_costo) || 0) : 0;

                return {
                    descripcion: item.descripcion,
                    monto: item.monto,
                    costo: costoUnitario // Enviamos el costo unitario
                };
            });

            const payload = {
                id_comerciante: comercianteData.id,
                tipo: 'INGRESO',
                monto: ventaActual.total,
                metodo: metodoPago,
                descripcion: ventaActual.items.map((item, i) => {
                    const cant = item.cantidad || 1;
                    return cant > 1 ? `${i + 1}. ${item.descripcion} x${cant}: $${item.monto.toFixed(2)}` : `${i + 1}. ${item.descripcion}: $${item.monto.toFixed(2)}`;
                }).join(', '),
                items: itemsConCosto, // Enviamos items enriquecidos
                fecha_hora: fechaHoraLocal,
                id_local: idLocal
            };

            // ‚úÖ Modo OFFLINE
            if (!isOnline) {
                guardarEnQueue(payload);
                crearConfetti();
                mostrarNotificacion(`üì¥ Venta guardada offline (${metodoPago})`, 'warning');
                finalizarVentaExitosa();
                if (btn) btn.disabled = false;
                if (btnMob) btnMob.disabled = false;
                return;
            }

            // ‚úÖ Modo ONLINE
            try {
                const response = await fetch(WEBHOOKS.GUARDAR, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Error en servidor');

                crearConfetti();
                mostrarNotificacion(`‚úÖ Venta guardada (${metodoPago})`, 'success');
                finalizarVentaExitosa();

            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                guardarEnQueue(payload);
                mostrarNotificacion('‚ö†Ô∏è Guardado offline por error de conexi√≥n', 'warning');
                finalizarVentaExitosa();
            } finally {
                if (btn) btn.disabled = false;
                if (btnMob) btnMob.disabled = false;
            }
        }

        function finalizarVentaExitosa() {
            ventaActual = { items: [], total: 0 };
            limpiarVentaTemporal();
            actualizarDisplayTotal();
            actualizarListaItems();
            setTimeout(showMenuScreen, 1500);
        }

        async function guardarGasto() {
            const monto = parseFloat(document.getElementById('montoGasto').value);
            const cat = document.getElementById('categoriaGasto').value;
            const desc = document.getElementById('descripcionGasto').value;

            if (!monto || !cat) { mostrarNotificacion('‚ö†Ô∏è Completa monto y categor√≠a', 'error'); return; }

            const btn = document.getElementById('btnGuardarGasto');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> GUARDANDO...';
            btn.disabled = true;

            // ‚úÖ Generar ID local √∫nico para evitar duplicados
            const idLocal = `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            // ‚úÖ CORRECCI√ìN: Variables fuera del objeto payload
            const ahora = new Date();
            const fechaHoraLocal = new Date(ahora.getTime() - (ahora.getTimezoneOffset() * 60000))
                .toISOString()
                .replace('Z', '-03:00');

            const payload = {
                id_comerciante: comercianteData.id,
                tipo: 'GASTO',
                monto: monto,
                categoria: cat,
                descripcion: desc || `Gasto: ${cat}`,
                fecha_hora: fechaHoraLocal,
                id_local: idLocal
            };

            // ‚úÖ Si est√° OFFLINE, guardar en queue
            if (!isOnline) {
                guardarEnQueue(payload);
                mostrarNotificacion('üì¥ Gasto guardado offline', 'warning');

                document.getElementById('montoGasto').value = '';
                document.getElementById('categoriaGasto').value = '';
                document.getElementById('descripcionGasto').value = '';

                btn.innerHTML = '<i class="fa-solid fa-save"></i> GUARDAR GASTO';
                btn.disabled = false;
                setTimeout(showMenuScreen, 1500);
                return;
            }

            // ‚úÖ Si est√° ONLINE, enviar directo
            try {
                await fetch(WEBHOOKS.GUARDAR, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                mostrarNotificacion('‚úÖ Gasto guardado', 'success');
                document.getElementById('montoGasto').value = '';
                document.getElementById('categoriaGasto').value = '';
                document.getElementById('descripcionGasto').value = '';

                setTimeout(showMenuScreen, 1500);
            } catch (e) {
                console.error('‚ùå Error de conexi√≥n:', e);
                // Si falla, guardar en queue como backup
                guardarEnQueue(payload);
                mostrarNotificacion('‚ö†Ô∏è Guardado offline por error de conexi√≥n', 'warning');
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-save"></i> GUARDAR GASTO';
                btn.disabled = false;
            }
        }

        async function cargarHistorial() {
            const container = document.getElementById('transactionsContainer');
            if (!comercianteData.id) return;

            container.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin text-3xl mb-2"></i><p>Cargando datos...</p></div>';

            try {
                // ‚úÖ SE CORRIGI√ì LA L√ìGICA DE FECHAS EN 'obtenerRangoFechas' (Ver abajo)
                const { fechaDesde, fechaHasta } = obtenerRangoFechas(filtroActual);

                // ‚úÖ FIX: Agregar timestamp para evitar cach√© del navegador al cambiar de dispositivo
                // ‚úÖ FIX: Asegurar que el ID del comerciante se env√≠e correctamente en la URL
                const url = `${WEBHOOKS.HISTORIAL}?id_comerciante=${comercianteData.id}&fecha_desde=${fechaDesde}&fecha_hasta=${fechaHasta}&_t=${Date.now()}`;

                console.log('üìÖ Solicitando historial para:', comercianteData.id);
                console.log('üìÖ Fechas:', fechaDesde, 'a', fechaHasta);

                const response = await fetch(url);
                const data = await response.json();

                // ‚úÖ FIX ROBUSTEZ: B√∫squeda "chismosa" de los datos
                // Buscamos el array de transacciones donde sea que se esconda
                let result = [];
                if (Array.isArray(data)) {
                    result = data;
                } else if (data.transacciones && Array.isArray(data.transacciones)) {
                    result = data.transacciones;
                } else if (data.data && Array.isArray(data.data)) { // Estructura com√∫n de n8n
                    result = data.data;
                } else if (data.result && Array.isArray(data.result)) { // Otra estructura com√∫n
                    result = data.result;
                } else if (data.json && Array.isArray(data.json)) { // Otra variante
                    result = data.json;
                }

                console.log("Datos recibidos crudos:", data);
                console.log("Datos procesados como array:", result);

                transaccionesData = result;

                // Pasar las fechas para mostrarlas en la UI si est√° vac√≠o
                renderHistorial(transaccionesData, fechaDesde, fechaHasta);
            } catch (error) {
                console.error('Error Historial:', error);
                container.innerHTML = '<div class="text-center text-red-500 py-10">Error al cargar historial</div>';
            }
        }

        function cambiarFiltro(filtro) {
            filtroActual = filtro;
            document.querySelectorAll('.filter-tab').forEach(b => {
                b.classList.remove('bg-gray-700', 'text-white', 'active');
                b.classList.add('text-gray-400');
                if (b.dataset.filter === filtro) {
                    b.classList.add('bg-gray-700', 'text-white', 'active');
                    b.classList.remove('text-gray-400');
                }
            });
            cargarHistorial();
        }

        // ‚úÖ L√ìGICA DE FECHAS CORREGIDA (FIX PARA ARGENTINA/LATAM)
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function obtenerRangoFechas(filtro) {
            const ahora = new Date();
            let desde = new Date();

            // Resetear horas para comparaciones limpias
            desde.setHours(0, 0, 0, 0);

            if (filtro === 'semana') {
                const day = ahora.getDay();
                // Ajustar al domingo (0) o lunes seg√∫n preferencia, aqu√≠ restamos d√≠as desde hoy
                const diff = ahora.getDate() - day;
                desde.setDate(diff);
            } else if (filtro === 'mes') {
                desde.setDate(1);
            } else if (filtro === 'a√±o') {
                desde.setMonth(0, 1);
            }
            // Si es 'hoy', ya est√° en 00:00:00

            return {
                fechaDesde: formatDate(desde),
                fechaHasta: formatDate(ahora)
            };
        }

        function safeDate(dateStr) {
            if (!dateStr) return 'Fecha inv√°lida';
            const d = new Date(dateStr);
            if (!isNaN(d.getTime())) return d.toLocaleString();
            return dateStr.substring(0, 16).replace('T', ' ');
        }

        function renderHistorial(datos, fDesde, fHasta) {
            const container = document.getElementById('transactionsContainer');
            let ingresos = 0, gastos = 0;

            datos.forEach(t => {
                // ‚úÖ FIX: B√∫squeda flexible de campos (Robustez total)
                const tipo = (t.tipo || t.Tipo || t.type || '').toUpperCase();
                const monto = parseFloat(t.monto || t.Monto || t.amount || 0);

                if (tipo === 'INGRESO') ingresos += monto;
                if (tipo === 'GASTO' || tipo === 'EGRESO') gastos += monto;
            });

            // ‚úÖ RESUMEN EN PANTALLA ACTUALIZADO (HOY/SEMANA/MES)
            document.getElementById('totalIngresos').textContent = `$ ${ingresos.toFixed(2)}`;
            document.getElementById('totalGastos').textContent = `$ ${gastos.toFixed(2)}`;
            const balance = ingresos - gastos;
            const balanceEl = document.getElementById('balanceTotal');
            balanceEl.textContent = `$ ${balance.toFixed(2)}`;

            // Color din√°mico para el balance
            if (balance >= 0) {
                balanceEl.classList.remove('text-red-500');
                balanceEl.classList.add('text-white');
            } else {
                balanceEl.classList.add('text-red-500');
                balanceEl.classList.remove('text-white');
            }

            if (datos.length === 0) {
                // ‚úÖ Feedback visual de qu√© se consult√≥
                let rangoMsg = '';
                if (fDesde && fHasta) {
                    rangoMsg = `<br><span class="text-xs text-gray-600 mt-2 block">Consulta: ${fDesde} al ${fHasta}</span>`;
                }

                container.innerHTML = `<div class="text-center py-8 text-gray-500">
                    <p>No hay movimientos en este periodo</p>
                    ${rangoMsg}
                    <button onclick="cambiarFiltro('a√±o')" class="mt-4 text-xs text-primary underline">Ver todo el a√±o</button>
                </div>`;
                return;
            }

            container.innerHTML = datos.map(t => `
                <div class="glass-panel p-4 rounded-xl border border-gray-700/50 flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${(t.tipo || t.Tipo || '').toUpperCase() === 'INGRESO' ? 'bg-primary/10 text-primary' : 'bg-warning/10 text-warning'}">
                             <i class="fa-solid ${(t.tipo || t.Tipo || '').toUpperCase() === 'INGRESO' ? 'fa-arrow-down' : 'fa-arrow-up'} text-xl"></i>
                        </div>
                        <div>
                            <div class="font-bold text-white text-lg">${t.descripcion || t.Descripcion || t.notes || 'Sin descripci√≥n'}</div>
                            <div class="text-sm text-gray-400 mt-1">
                                <i class="fa-regular fa-clock mr-1"></i>
                                ${safeDate(t.fecha_hora || t.created_at || t.fecha)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-right w-full md:w-auto flex flex-col md:items-end gap-2">
                        <div class="font-mono font-bold text-2xl ${(t.tipo || t.Tipo || '').toUpperCase() === 'INGRESO' ? 'text-primary' : 'text-warning'}">
                            ${(t.tipo || t.Tipo || '').toUpperCase() === 'INGRESO' ? '+' : '-'} $${parseFloat(t.monto || t.Monto || 0).toFixed(2)}
                        </div>
                        <div class="flex gap-3 justify-end">
                            <button onclick="editarTransaccion('${t.id}')" 
                                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-blue-500/10 text-blue-400 border border-blue-500/20 hover:bg-blue-500 hover:text-white text-xs font-bold uppercase">
                                <i class="fa-solid fa-pen"></i> Editar
                            </button>
                            <button onclick="eliminarTransaccion('${t.id}')" 
                                class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500 hover:text-white text-xs font-bold uppercase">
                                <i class="fa-solid fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function editarTransaccion(id) {
            const tx = transaccionesData.find(t => t.id === id);
            if (!tx) return;

            transaccionEditando = id;
            document.getElementById('editMonto').value = tx.monto;
            document.getElementById('editDescripcion').value = tx.descripcion;

            document.getElementById('modalEdit').classList.remove('hidden');
            document.getElementById('modalEdit').classList.add('flex');
        }

        function cerrarModalEdit() {
            document.getElementById('modalEdit').classList.add('hidden');
            document.getElementById('modalEdit').classList.remove('flex');
            transaccionEditando = null;
        }

        async function guardarEdicion() {
            if (!transaccionEditando) return;

            const monto = parseFloat(document.getElementById('editMonto').value);
            const desc = document.getElementById('editDescripcion').value;

            if (!monto) { mostrarNotificacion('‚ö†Ô∏è Monto inv√°lido', 'error'); return; }

            try {
                await fetch(WEBHOOKS.EDITAR, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: transaccionEditando,
                        monto: monto,
                        descripcion: desc,
                        comercio_id: comercianteData.id
                    })
                });

                mostrarNotificacion('‚úÖ Actualizado correctamente', 'success');
                cerrarModalEdit();
                cargarHistorial();
            } catch (e) {
                console.error(e);
                mostrarNotificacion('‚ùå Error al actualizar', 'error');
            }
        }

        async function eliminarTransaccion(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta transacci√≥n?')) return;

            try {
                await fetch(WEBHOOKS.ELIMINAR, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: id,
                        comercio_id: comercianteData.id
                    })
                });

                mostrarNotificacion('üóëÔ∏è Transacci√≥n eliminada', 'success');
                cargarHistorial();
            } catch (e) {
                console.error(e);
                mostrarNotificacion('‚ùå Error al eliminar', 'error');
            }
        }

        let productoEditando = null;

        // ‚úÖ 4. Funci√≥n Editar Producto: Cargar Costo
        function editarProducto(id, codigo) {
            const prod = inventario.find(p => p.id == id || p.codigo == id || p.codigo == codigo);
            if (!prod) {
                console.error("‚ùå No se encontr√≥ el producto en el inventario local:", id, codigo);
                return;
            }

            // ‚úÖ CORREGIDO: Priorizar siempre el c√≥digo de barras si existe, sino el ID
            productoEditando = prod.codigo || prod.codigo_barra || prod.id;
            console.log("üìù Editando producto (ID/C√≥digo):", productoEditando, prod);

            document.getElementById('editInvNombre').value = prod.nombre;
            document.getElementById('editInvCategoria').value = prod.categoria || prod.Categoria || '';

            // Usamos precio_final si existe (n8n standard), sino precio
            document.getElementById('editInvPrecio').value = prod.precio_final || prod.precio;

            // Stock
            document.getElementById('editInvStock').value = (prod.stock != null) ? prod.stock : (prod.stock_actual != null ? prod.stock_actual : 0);

            // C√≥digo (mostramos el que se usar√° para actualizar)
            document.getElementById('editInvCodigo').value = productoEditando;

            // ‚úÖ CARGAR COSTO Y GANANCIA
            document.getElementById('editInvCosto').value = prod.precio_costo || 0;
            document.getElementById('editInvGanancia').value = prod.ganancia_porcentaje || 0;

            document.getElementById('modalEditProducto').classList.remove('hidden');
            document.getElementById('modalEditProducto').classList.add('flex');
        }

        function cerrarModalEditProducto() {
            document.getElementById('modalEditProducto').classList.add('hidden');
            document.getElementById('modalEditProducto').classList.remove('flex');
            productoEditando = null;
        }

        // ‚úÖ 5. Funci√≥n Guardar Edici√≥n: Enviar Costo
        async function guardarEdicionProducto() {
            if (!productoEditando) return;

            const nombre = document.getElementById('editInvNombre').value.trim();
            const categoria = document.getElementById('editInvCategoria').value.trim();
            const precio = parseFloat(document.getElementById('editInvPrecio').value);
            const stock = parseInt(document.getElementById('editInvStock').value) || 0;

            // ‚úÖ LEER COSTO Y GANANCIA
            const costo = parseFloat(document.getElementById('editInvCosto').value) || 0;
            const ganancia = parseFloat(document.getElementById('editInvGanancia').value) || 0;

            if (!nombre || !precio) { mostrarNotificacion('‚ö†Ô∏è Nombre y Precio requeridos', 'error'); return; }

            // ‚úÖ CORRECCI√ìN: Payload correcto para editar inventario
            const payload = {
                codigo: productoEditando,
                id_comerciante: comercianteData.id,
                nombre: nombre,
                categoria: categoria,
                precio: precio,
                stock: stock,
                precio_costo: costo,
                ganancia_porcentaje: ganancia
            };

            console.log("üöÄ Enviando actualizaci√≥n a n8n:", payload);

            try {
                const response = await fetch(WEBHOOKS.INVENTARIO_ACTUALIZAR, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error en n8n: ${response.status} - ${errorText}`);
                }

                mostrarNotificacion('‚úÖ Producto actualizado', 'success');
                cerrarModalEditProducto();
                await cargarInventario(true);
            } catch (e) {
                console.error("‚ùå Error en guardarEdicionProducto:", e);
                mostrarNotificacion(`‚ùå Error: ${e.message}`, 'error');
            }
        }

        // --- REPORTES ---
        function abrirModalReporte() {
            document.getElementById('modalSolicitarReporte').classList.remove('hidden');
            document.getElementById('modalSolicitarReporte').classList.add('flex');
        }

        function cerrarModalReporte() {
            document.getElementById('modalSolicitarReporte').classList.add('hidden');
            document.getElementById('modalSolicitarReporte').classList.remove('flex');
        }

        // ‚úÖ L√ìGICA ACTIVADA: ENVIAR REPORTE (REVISADA)
        async function enviarSolicitudReporte(periodo) {
            cerrarModalReporte();

            if (!isOnline) {
                mostrarNotificacion('‚ùå Necesitas internet para solicitar reportes', 'error');
                return;
            }

            // ‚úÖ VALIDACI√ìN EXTRA: ¬øTenemos el ID del comerciante?
            if (!comercianteData.id) {
                mostrarNotificacion('‚ö†Ô∏è Error: ID de comercio no detectado', 'error');
                console.error("ID de comercio faltante al solicitar reporte");
                return;
            }

            mostrarNotificacion(`üìß Solicitando reporte (${periodo})...`, 'warning');
            console.log(`Solicitando reporte para periodo: ${periodo} (ID: ${comercianteData.id})`);

            try {
                // Obtenemos fechas exactas para el reporte
                const { fechaDesde, fechaHasta } = obtenerRangoFechas(periodo);

                // ‚úÖ PAYLOAD EXACTO SEG√öN TU SOLICITUD (Solo ID y fechas)
                const response = await fetch(WEBHOOKS.REPORTE_EMAIL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_comerciante: comercianteData.id,
                        periodo: periodo, // "hoy", "semana", "mes"
                        fecha_desde: fechaDesde,
                        fecha_hasta: fechaHasta
                    })
                });

                if (response.ok) {
                    mostrarNotificacion(`‚úÖ Solicitud enviada correctamente`, 'success');
                } else {
                    throw new Error('Error al generar reporte');
                }

            } catch (e) {
                console.error(e);
                mostrarNotificacion('‚ùå Error de conexi√≥n al solicitar reporte', 'error');
            }
        }

        async function eliminarProducto(id, codigo) {
            const ident = codigo || id;
            if (!confirm(`¬øEst√°s seguro de eliminar el producto ${ident}?`)) return;

            try {
                await fetch(WEBHOOKS.INVENTARIO_ELIMINAR, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ident,
                        comercio_id: comercianteData.id
                    })
                });

                // Eliminamos del estado local inmediatamente para feedback visual
                inventario = inventario.filter(p => (p.id != id && p.codigo != id) && (p.id != ident && p.codigo != ident));
                renderInventarioList();

                mostrarNotificacion('üóëÔ∏è Producto eliminado', 'success');
                await cargarInventario(true); // Forzar recarga fresh del servidor
            } catch (e) {
                console.error(e);
                mostrarNotificacion('‚ùå Error al eliminar producto', 'error');
            }
        }

        function mostrarNotificacion(msg, type) {
            const notif = document.getElementById('notification');
            const icon = document.getElementById('notifIcon');
            const text = document.getElementById('notifMessage');

            text.textContent = msg;
            notif.classList.remove('hidden', 'border-primary', 'border-warning', 'border-red-500');

            if (type === 'success') { notif.classList.add('bg-gray-800', 'text-white', 'border-primary'); icon.innerHTML = '‚úÖ'; }
            if (type === 'error') { notif.classList.add('bg-gray-800', 'text-white', 'border-red-500'); icon.innerHTML = '‚ùå'; }
            if (type === 'warning') { notif.classList.add('bg-gray-800', 'text-white', 'border-warning'); icon.innerHTML = '‚ö†Ô∏è'; }

            notif.classList.remove('translate-x-[150%]');
            setTimeout(() => notif.classList.add('translate-x-[150%]'), 3000);
        }

        function crearConfetti() {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#10b981', '#3b82f6', '#f59e0b'] });
        }

        function guardarVentaTemporal() { localStorage.setItem('venta_temp', JSON.stringify(ventaActual)); }
        function cargarVentaGuardada() {
            const saved = localStorage.getItem('venta_temp');
            if (saved) {
                ventaActual = JSON.parse(saved);
                contadorProductos = ventaActual.items.length + 1;
                actualizarDisplayTotal();
                actualizarListaItems();
            }
        }
        function limpiarVentaTemporal() { localStorage.removeItem('venta_temp'); }

        // ==========================================
        //  FUNCIONES DE CONFIGURACI√ìN
        // ==========================================

        function cerrarSesion() {
            if (confirm('¬øEst√°s seguro que deseas cerrar sesi√≥n?')) {
                // Verificar transacciones pendientes
                const queue = obtenerQueue();

                if (queue.length > 0) {
                    alert(`‚ö†Ô∏è Tienes ${queue.length} transacciones pendientes de sincronizar. Por favor conecta a internet antes de cerrar sesi√≥n.`);
                    return;
                }

                // ‚úÖ GUARDAR DATOS QUE QUEREMOS MANTENER (Configuraci√≥n local del dispositivo)
                // Esto es necesario porque queremos limpiar la sesi√≥n pero no las preferencias del dispositivo
                const sonidos = localStorage.getItem('sonidosEnabled');

                // Guardamos las im√°genes de perfil de todos los usuarios que hayan iniciado sesi√≥n aqu√≠
                // Filtramos las keys que empiezan con 'perfil_imagen_'
                const imagenesPerfil = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('perfil_imagen_')) {
                        imagenesPerfil[key] = localStorage.getItem(key);
                    }
                }

                // Limpiar todo (seguro para borrar datos sensibles)
                localStorage.clear();
                sessionStorage.clear();

                // ‚úÖ RESTAURAR PREFERENCIAS
                if (sonidos !== null) localStorage.setItem('sonidosEnabled', sonidos);

                // Restaurar im√°genes
                Object.keys(imagenesPerfil).forEach(key => {
                    localStorage.setItem(key, imagenesPerfil[key]);
                });

                // Redirigir al login
                window.location.href = 'index.html';
            }
        }

        function limpiarCache() {
            if (confirm('¬øLimpiar todos los datos locales? Esta acci√≥n no se puede deshacer.\n\nNota: Las transacciones pendientes de sincronizar se perder√°n.')) {
                localStorage.clear();
                mostrarNotificacion('üóëÔ∏è Cach√© limpiado', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        }

        function toggleSonido() {
            const sonidoToggle = document.getElementById('sonidoToggle');
            const enabled = sonidoToggle.checked;
            localStorage.setItem('sonidosEnabled', enabled);
            mostrarNotificacion(enabled ? 'üîî Sonidos habilitados' : 'üîï Sonidos deshabilitados', 'success');
        }

        // ==========================================
        //  L√ìGICA PERFIL DE USUARIO
        // ==========================================

        function abrirPerfil() {
            document.getElementById('modalPerfil').classList.remove('hidden');

            // Actualizar Datos
            document.getElementById('perfilNombre').textContent = comercianteData.nombre || 'Comerciante';
            document.getElementById('perfilId').textContent = `ID: ${comercianteData.id || '---'}`;
            document.getElementById('perfilComercio').textContent = comercianteData.nombre || 'Mi Comercio';

            // Cargar imagen si existe
            cargarImagenPerfilUI();
        }

        function cerrarPerfil() {
            document.getElementById('modalPerfil').classList.add('hidden');
        }

        function actualizarFotoPerfil(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    const imageData = e.target.result;
                    // Guardar en localStorage
                    localStorage.setItem('perfil_imagen_' + comercianteData.id, imageData);

                    // Actualizar UI
                    cargarImagenPerfilUI();
                    mostrarNotificacion('üì∏ Foto de perfil actualizada', 'success');
                }

                reader.readAsDataURL(input.files[0]);
            }
        }

        function cargarImagenPerfilUI() {
            const savedImage = localStorage.getItem('perfil_imagen_' + comercianteData.id);
            const defaultImage = `https://ui-avatars.com/api/?name=${encodeURIComponent(comercianteData.nombre || 'User')}&background=random&size=128`;

            const src = savedImage || defaultImage;

            // Actualizar todas las instancias de la imagen de perfil
            const imgs = document.querySelectorAll('#profileImageBtn, #profileImageModal');
            imgs.forEach(img => img.src = src);

            // Actualizar nombre peque√±o
            const miniName = document.getElementById('miniPerfilNombre');
            if (miniName) miniName.textContent = (comercianteData.nombre || 'Comerciante').split(' ')[0];
        }

        // Cargar imagen al iniciar tambi√©n
        document.addEventListener('DOMContentLoaded', () => {
            // Un peque√±o delay para asegurar que comercianteData tenga algo si viene de cach√©
            setTimeout(cargarImagenPerfilUI, 500);
        });

        // Enter key handlers
        document.addEventListener('DOMContentLoaded', function () {
            const montoInput = document.getElementById('montoInput');
            const descInput = document.getElementById('descripcionInput');

            if (montoInput) {
                montoInput.addEventListener('keyup', function (e) {
                    if (e.key === 'Enter' && this.value && parseFloat(this.value) > 0) {
                        agregarItem();
                    }
                });
            }

            if (descInput) {
                descInput.addEventListener('keydown', function (e) {
                    const items = document.querySelectorAll('.search-result-item');

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedResultIndex = Math.min(selectedResultIndex + 1, items.length - 1);
                        highlightResult(selectedResultIndex);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedResultIndex = Math.max(selectedResultIndex - 1, -1);
                        highlightResult(selectedResultIndex);
                    } else if (e.key === 'Enter') {
                        if (selectedResultIndex >= 0 && items[selectedResultIndex]) {
                            e.preventDefault();
                            const item = items[selectedResultIndex];
                            seleccionarProducto(item.dataset.nombre, item.dataset.precio);
                        } else {
                            // Comportamiento original si no hay nada seleccionado
                            // PERO: Ahora tenemos handleVentasEnter en el inline HTML
                            // Podemos dejar esto como fallback si falla el inline, 
                            // o quitarlo para evitar doble trigger.
                            // Mejor dejar que el inline maneje la l√≥gica principal de b√∫squeda por c√≥digo.
                            // Si no es c√≥digo, el inline pasa el foco a montoInput.
                        }
                    }
                });
            }

            const montoGasto = document.getElementById('montoGasto');
            if (montoGasto) {
                montoGasto.addEventListener('keyup', function (e) {
                    if (e.key === 'Enter') {
                        const cat = document.getElementById('categoriaGasto').value;
                        if (this.value && parseFloat(this.value) > 0 && cat) {
                            guardarGasto();
                        }
                    }
                });
            }
        });

        // ‚úÖ JS FORCE: Agresivo script para asegurar que el chat suba en m√≥vil
        // N8n a veces inyecta estilos inline que ganan al CSS !important
        let checkCount = 0;
        const forceChatPosition = () => {
            if (window.innerWidth <= 768) {
                // Buscamos el bot√≥n y el iframe por todas sus clases posibles
                const cBtn = document.querySelector('.n8n-chat-widget-button') || document.querySelector('[class*="chat-widget-button"]');
                const cFrame = document.querySelector('.n8n-chat-widget iframe') || document.querySelector('iframe[src*="n8n"]');
                const cTarget = document.getElementById('n8n-chat-target');

                if (cBtn) {
                    cBtn.style.setProperty('bottom', '120px', 'important');
                    cBtn.style.setProperty('top', 'auto', 'important'); // Evitar conflicto
                    cBtn.style.setProperty('z-index', '2147483647', 'important'); // Max Z-index
                }
                if (cFrame) {
                    cFrame.style.setProperty('bottom', '120px', 'important');
                    cFrame.style.setProperty('top', 'auto', 'important');
                    cFrame.style.setProperty('z-index', '2147483647', 'important');
                }
            } else {
                // Reset en escritorio
                const cBtn = document.querySelector('.n8n-chat-widget-button');
                if (cBtn) {
                    cBtn.style.bottom = '';
                    cBtn.style.top = '';
                }
            }
        };

        // Ejecutar r√°pido al principio, luego mantener
        const fastInterval = setInterval(() => {
            forceChatPosition();
            checkCount++;
            if (checkCount > 50) clearInterval(fastInterval); // Parar el r√°pido a los 5s
        }, 100);

        setInterval(forceChatPosition, 1000); // Mantenimiento continuo
        // ==========================================
//  CERRAR MODALES AL HACER CLIC AFUERA
// ==========================================

document.addEventListener('DOMContentLoaded', function() {
    
    // 1Ô∏è‚É£ MODAL PERFIL - Cerrar al hacer clic en el fondo oscuro
    const modalPerfil = document.getElementById('modalPerfil');
    
    if (modalPerfil) {
        modalPerfil.addEventListener('click', function(e) {
            // Si el clic fue en el fondo oscuro (no en el contenido)
            if (e.target === modalPerfil) {
                cerrarPerfil();
            }
        });
    }
    
    // 2Ô∏è‚É£ OTROS MODALES EXISTENTES - Cerrar al hacer clic afuera
    const modalesConFondo = [
        { modal: 'modalCobro', cerrar: cerrarModalCobro },
        { modal: 'modalEdit', cerrar: cerrarModalEdit },
        { modal: 'modalEditProducto', cerrar: cerrarModalEditProducto },
        { modal: 'modalSolicitarReporte', cerrar: cerrarModalReporte }
    ];
    
    modalesConFondo.forEach(item => {
        const modal = document.getElementById(item.modal);
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    item.cerrar();
                }
            });
        }
    });
    
    // 3Ô∏è‚É£ TECLA ESC para cerrar cualquier modal visible
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' || e.key === 'Esc') {
            // Cerrar modal de perfil si est√° abierto
            if (modalPerfil && !modalPerfil.classList.contains('hidden')) {
                cerrarPerfil();
            }
            // Cerrar modal de cobro si est√° abierto
            const modalCobro = document.getElementById('modalCobro');
            if (modalCobro && modalCobro.classList.contains('flex')) {
                cerrarModalCobro();
            }
            // Cerrar modal de edici√≥n si est√° abierto
            const modalEdit = document.getElementById('modalEdit');
            if (modalEdit && modalEdit.classList.contains('flex')) {
                cerrarModalEdit();
            }
            // Cerrar modal de editar producto si est√° abierto
            const modalEditProd = document.getElementById('modalEditProducto');
            if (modalEditProd && modalEditProd.classList.contains('flex')) {
                cerrarModalEditProducto();
            }
            // Cerrar modal de reporte si est√° abierto
            const modalReporte = document.getElementById('modalSolicitarReporte');
            if (modalReporte && modalReporte.classList.contains('flex')) {
                cerrarModalReporte();
            }
        }
    });
});
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registrado'))
                    .catch(err => console.log('Error:', err));
            });
        }
    </script>
<script type="module">
    import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

    // Guardamos el chat en una variable global para controlarlo
    window.chatInstance = createChat({
        webhookUrl: 'https://n8n.arnaldoayalaestratega.com/webhook/d13fd268-2d98-4538-b7a6-fcc82e46be6d/chat',
        target: '#n8n-chat-target',
        mode: 'window',
        showWelcomeMessage: false,
        initialMessages: [
            '¬°Hola! üëã',
            'Soy tu asistente para comerciantes. ¬øQu√© duda tienes sobre el funcionamiento de la app?'
        ],
        i18n: {
            en: {
                title: 'Asistencia 360',
                welcome: '¬°Hola! üëã ¬øEn qu√© puedo ayudarte con la app?',
                subtitle: 'Estamos aqu√≠ para ayudarte 24/7',
                inputPlaceholder: 'Escribe tu consulta...',
                getStarted: 'Iniciar Chat',
                close: 'Cerrar'
            }
        },
        theme: {
            button: {
                backgroundColor: '#e91e63',
                iconColor: '#ffffff'
            }
        },
        messageParser: (message) => {
            try {
                // Si el mensaje ya es un objeto con text y buttons
                if (typeof message === 'object' && message.text) {
                    const texto = message.text;
                    const botones = message.buttons || [];

                    if (botones.length === 0) {
                        return texto;
                    }

                    // Construir mensaje con botones en formato Markdown
                    let mensajeFinal = texto + '\n\n';
                    
                    botones.forEach(btn => {
                        const etiqueta = btn.etiqueta || btn.label || 'Enlace';
                        const url = btn.url;
                        
                        let emoji = 'üîó';
                        const labelLower = etiqueta.toLowerCase();
                        if (labelLower.includes('whatsapp')) emoji = 'üí¨';
                        else if (labelLower.includes('instagram')) emoji = 'üì∏';
                        else if (labelLower.includes('web') || labelLower.includes('sitio')) emoji = 'üåê';
                        
                        // Formato Markdown: [texto](url)
                        mensajeFinal += `${emoji} [${etiqueta}](${url})\n`;
                    });

                    return mensajeFinal;
                }

                // Si es string, intentar parsear
                if (typeof message === 'string') {
                    try {
                        const parsed = JSON.parse(message);
                        if (parsed.text || parsed.respuesta) {
                            return this.messageParser(parsed);
                        }
                    } catch (e) {
                        // No es JSON, devolver como est√°
                        return message;
                    }
                }

                return message;

            } catch (error) {
                console.error('Error en messageParser:', error);
                return message;
            }
        }
    });

    // Funci√≥n para mostrar/ocultar el chat
    window.toggleBot = function (show) {
        const chatContainer = document.getElementById('n8n-chat-target');
        if (chatContainer) {
            chatContainer.style.display = show ? 'block' : 'none';
        }
    };
</script>
   <script>
(function() {
    let leyendaCreada = false;
    
    function aplicarEstilosForzados() {
        const isMobile = window.innerWidth <= 768;
        
        // 1. LLAVE DE SEGURIDAD: Detectar si estamos en Inicio
        const menuInicio = document.getElementById('menu-screen');
        const estaEnInicio = menuInicio && menuInicio.classList.contains('active');
        
        // 2. BOT√ìN - ULTRA AGRESIVO
        const chatButton = document.querySelector('.n8n-chat-widget-button, [class*="chat"][class*="button"]');
        
        if (chatButton) {
            if (isMobile) {
                // ‚úÖ FORZAR POSICI√ìN M√ìVIL (ENCIMA DEL MEN√ö)
                chatButton.style.setProperty('bottom', '90px', 'important');
                chatButton.style.setProperty('right', '20px', 'important');
                chatButton.style.setProperty('z-index', '999999', 'important');
                chatButton.style.setProperty('position', 'fixed', 'important');
                
                // ‚úÖ ELIMINAR CUALQUIER TRANSFORM O TOP QUE PUEDA INTERFERIR
                chatButton.style.setProperty('transform', 'none', 'important');
                chatButton.style.setProperty('top', 'auto', 'important');
            } else {
                chatButton.style.setProperty('bottom', '20px', 'important');
                chatButton.style.setProperty('right', '20px', 'important');
            }
        }
        
        // 3. IFRAME - ULTRA AGRESIVO
        const chatIframe = document.querySelector('.n8n-chat-widget iframe, iframe[src*="n8n"]');
        
        if (chatIframe) {
            if (isMobile) {
                chatIframe.style.setProperty('bottom', '90px', 'important');
                chatIframe.style.setProperty('z-index', '999998', 'important');
                chatIframe.style.setProperty('position', 'fixed', 'important');
                chatIframe.style.setProperty('top', 'auto', 'important');
            } else {
                chatIframe.style.setProperty('bottom', '20px', 'important');
            }
        }
        
        // 4. LEYENDA DIN√ÅMICA (Solo si es Inicio)
        let leyenda = document.getElementById('chat-leyenda-custom');
        
        if (chatButton && estaEnInicio && !leyendaCreada) {
            if (!leyenda) {
                leyenda = document.createElement('div');
                leyenda.id = 'chat-leyenda-custom';
                leyenda.textContent = '¬øNecesitas ayuda? Preg√∫ntame aqu√≠...';
                
                leyenda.style.position = 'fixed';
                leyenda.style.background = '#e91e63';
                leyenda.style.color = 'white';
                leyenda.style.padding = '8px 16px';
                leyenda.style.borderRadius = '20px';
                leyenda.style.fontSize = '14px';
                leyenda.style.fontWeight = 'bold';
                leyenda.style.boxShadow = '0 4px 10px rgba(0,0,0,0.3)';
                leyenda.style.pointerEvents = 'none';
                leyenda.style.zIndex = '999999';
                leyenda.style.whiteSpace = 'nowrap';
                leyenda.style.transition = 'all 0.3s ease';
                leyenda.style.opacity = '1';
                
                if (isMobile) {
                    // ‚úÖ PEGADA AL BOT√ìN DEL CHAT
                    leyenda.style.bottom = '155px'; // 90px (bot√≥n) + 65px (altura aprox)
                    leyenda.style.left = '50%';
                    leyenda.style.transform = 'translateX(-50%)';
                    leyenda.style.fontSize = '12px';
                    leyenda.style.padding = '6px 12px';
                } else {
                    leyenda.style.bottom = '30px';
                    leyenda.style.right = '90px';
                }
                
                document.body.appendChild(leyenda);
                leyendaCreada = true;
                
                // Auto-hide despu√©s de 5 segundos
                setTimeout(() => {
                    if (leyenda) {
                        leyenda.style.opacity = '0';
                        setTimeout(() => {
                            if (leyenda && leyenda.parentNode) {
                                leyenda.parentNode.removeChild(leyenda);
                                leyendaCreada = false;
                            }
                        }, 300);
                    }
                }, 5000);
            }
        } 
        // Si sale de inicio, borramos la leyenda si existe
        else if (leyenda && !estaEnInicio) {
            leyenda.remove();
            leyendaCreada = false;
        }
    }
    
    // ‚úÖ EJECUCI√ìN ULTRA AGRESIVA
    let contador = 0;
    const intervaloRapido = setInterval(() => {
        aplicarEstilosForzados();
        contador++;
        if (contador > 100) clearInterval(intervaloRapido); // 10 segundos de fuerza bruta
    }, 100);
    
    // Mantenimiento continuo cada medio segundo (m√°s frecuente)
    setInterval(aplicarEstilosForzados, 500);
    
    // Escuchar cambios de tama√±o
    window.addEventListener('resize', aplicarEstilosForzados);
    
    // Ejecutar inmediatamente
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', aplicarEstilosForzados);
    } else {
        aplicarEstilosForzados();
    }
    
    // ‚úÖ NUEVO: Observar cambios en el DOM (por si n8n inyecta despu√©s)
    const observer = new MutationObserver(() => {
        aplicarEstilosForzados();
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style', 'class']
    });
})();
</script>
</body>
</html>
